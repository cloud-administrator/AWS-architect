# 【初心者向け完全ガイド】Azure API Management (APIM) で実現する社内 AI 導入プロジェクト

> [!NOTE]
> 本ガイドは、Azure API Management (APIM) の導入を検討しているプロジェクトメンバー、特に**非技術者の方**を対象に,AI 導入における APIM の役割、メリット、具体的な活用事例を、分かりやすく、かつ網羅的に解説するものです。

---

## 📖 目次

1.  **はじめに：なぜ「AI の導入」に「管理」が必要なのか？**
2.  **基本編：Azure APIM の仕組みを「レストラン」で理解する**
3.  **機能編：AI 活用を加速させる「AI Gateway」の凄さ**
4.  **実践編：よくある 3 つの活用ケーススタディ**
5.  **手順編：ゼロから始める AI プロキシ構築ステップ**
6.  **運用編：セキュリティとコスト管理のベストプラクティス**
7.  **よくある質問 (Q&A)**

---

## 1. はじめに：なぜ「AI の導入」に「管理」が必要なのか？

「社内で ChatGPT (Azure OpenAI) を使えるようにしたい！」
そう意気込んでプロジェクトが始まると、必ず直面する**「3 つの壁」**があります。

### 🚨 AI 導入プロジェクトの「3 つの壁」

1.  **💰 青天井のコストリスク**
    *   従量課金制の AI は、誰かが無限に使えば、請求も無限に増えます。「ある部署が実験で大量の処理を回して、予算を使い果たした…」という事故は現実に起きています。
2.  **🔐 セキュリティとガバナンスの不安**
    *   「機密情報を間違って入力したらどうする？」「退職した社員がまだアクセスできていないか？」といった、企業としての統制が必要です。
3.  **📉 サービスの安定性 (レート制限)**
    *   Azure OpenAI には「1 分間に何回まで」という厳しい**レート制限 (TPM/RPM)** があります。みんなが一斉に使うと、すぐに「429 エラー (混み合っています)」が出てしまい、業務が止まってしまいます。

### 🛡️ 救世主としての「Azure API Management (APIM)」

これらすべての問題を解決するために、**「ユーザー(社員)」と「AI (Azure OpenAI)」の間に立つ「仲介役」**が必要です。それが **Azure API Management** です。

イメージしてください。
*   あなた (社員) は、AI という「大物スター」に会いたいと思っています。
*   しかし、スターに直接突撃すると、パニックになります。
*   そこで、間に**「優秀なマネージャー (APIM)」**を置きます。
*   マネージャーは、「あなたは通ってよし」「今は休憩中だから待って」「君は使いすぎだからダメ」と整理してくれます。

この「整理役」ができることこそが、APIM の価値です。

---

## 2. 基本編：Azure APIM の仕組みを「レストラン」で理解する

技術的な言葉 (エンドポイント、ポリシー、バックエンド...) が出てくると難しく感じますが、**「レストラン」**に例えると非常にシンプルです。

### 🍽️ APIM レストランの登場人物

| APIM の用語 | レストランでの役割 | 説明 |
| :--- | :--- | :--- |
| **ユーザー (Client)** | **お客様** | AI を利用したい社員や、社内システム。 |
| **API Gateway (ゲートウェイ)** | **ウェイター / 受付** | お客様の注文を聞き、厨房に伝え、料理を運ぶ窓口。お客様は厨房の中を知る必要はありません。 |
| **Backend (バックエンド)** | **厨房 (シェフ)** | 実際に料理を作る場所。ここでは「Azure OpenAI」などの AI サービスそのもの。 |
| **Policy (ポリシー)** | **マニュアル / ルール** | 「未成年にお酒は出さない」「常連さんにはサービスする」といった、お店独自のルール。 |
| **Product (プロダクト)** | **メニュー / コース** | 「ランチコース」「ディナーコース」のように、サービスをパッケージ化したもの。 |
| **Subscription (サブスクリプション)** | **会員証 / 食券** | そのコースを注文するための権利。誰が食べたかを記録する ID でもあります。 |

### 🖼️ 仕組みの全体像

お客様 (社員) は、厨房 (AI) に直接注文するのではなく、必ずウェイター (APIM) に注文します。

```mermaid
graph LR
    subgraph "社内ネットワーク"
    User[社員 / アプリ] -->|1. 注文 (プロンプト)| APIM[👮‍♀️ APIM (ウェイター)]
    end

    subgraph "Azure クラウド"
    APIM -->|2. ルール確認 (ポリシー)| Check{ルールOK?}
    Check -- Yes --> Backend[🧠 Azure OpenAI (厨房)]
    Check -- No (使いすぎ/権限なし) --> Reject[🚫 拒否]
    Backend -->|3. 料理 (回答)| APIM
    APIM -->|4. 提供| User
    end
```

### 🔑 重要な 3 つの概念

APIM を理解するために、これだけは覚えておきたい 3 つのキーワードがあります。

#### ① フロントエンドとバックエンドの分離
お客様は「厨房のどこに冷蔵庫があるか」を知らなくて良いように、社員は「AI がどこのリージョン (東日本？米国？) で動いているか」を気にする必要がありません。APIM が裏側を隠蔽（抽象化）してくれるため、裏側の構成を変えても社員には影響がありません。

#### ② ポリシー (Policy) - APIM の「魔法」
APIM の最大の特徴は、リクエストの途中で**「加工」**や**「判断」**ができることです。
*   **リクエスト時**: 「この人、今月の予算超えてない？」「怪しいキーワード入ってない？」
*   **レスポンス時**: 「余計な情報が入ってない？」「ログに記録しておこう」
これらを、コードを書かずに設定 (XML 形式の構成) だけで実現できます。

#### ③ 開発者ポータル
レストランの外にある「メニューサンプル」のような Web サイトです。開発者 (社内のエンジニア) は、ここを見て「どんな API が使えるのか」「使い方はどうすればいいか」を確認し、TESTすることができます。

---

> [!TIP]
> **初心者のためのポイント**
> APIM は単なる「通り道」ではありません。**「高機能な関所」**です。ここを通すことで、AI に対して「誰が」「いつ」「どれくらい」使ったかを完全にコントロールできるようになります。

---
(続く：次章「機能編：AI 活用を加速させる AI Gateway の凄さ」へ)

---

## 3. 機能編：AI 活用を加速させる「AI Gateway」の凄さ

Azure APIM には、AI (特に Azure OpenAI) のために作られた特別な機能群**「GenAI Gateway」**があります。これがなければ、AI 導入は失敗すると言っても過言ではありません。

### 👮‍♀️ ① GenAI Token Limit (トークン制限) - 「リクエスト数」ではなく「量」で守る

従来の API 制限は「1 分間に 10 回まで」という「回数」の制限でした。
しかし、AI の世界では、**「こんにちは (1トークン)」**という 1 回と、**「この本の要約をして (1万トークン)」**という 1 回は、負荷もコストも全く違います。

APIM の「トークン制限機能」は、リクエストの中身を覗き込み、**「今月はあと何文字分使えるか」**を正確にカウントして制限します。

> [!IMPORTANT]
> **なぜこれが必要？**
> Azure OpenAI の課金は「トークン単位」です。回数制限だけでは、コストの爆発を防げません。「トークン制限」こそが、予算を守る唯一の盾です。

---

### 🚦 ② スマートロードバランシング - 「渋滞」を回避する交通整理

Azure OpenAI は人気のため、特定のリージョン (例：米国東部) が混雑し、使えなくなることがあります。
APIM の「ロードバランサー」機能を使うと、以下のような交通整理を自動で行います。

1.  まず「日本 (Japan East)」にリクエストを送る。
2.  日本が混んでいたら、自動的に「米国 (East US)」へ転送。
3.  米国もダメなら「欧州 (West Europe)」へ。

ユーザーは「どこの国の AI」を使っているか意識する必要はありません。APIM が裏で空いている場所を探してくれるため、**「システムが止まらない」**環境を作れます。

---

### 📚 ③ Semantic Caching (意味的キャッシュ) - 「同じ質問」には「0秒」で答える

AI への質問は、同じような内容が多いものです。
*   Aさん：「就業規則を教えて」
*   Bさん：「会社のルールを知りたい」
*   Cさん：「就業規則はどこ？」

これらは言葉は違いますが、**意味は同じ**です。
APIM の「Semantic Caching (セマンティックキャッシュ)」は、AI が一度答えた内容を記憶します。そして、**「意味が似ている質問」が来たら、AI に聞かずに、APIM が記憶から即座に回答します。**

*   **メリット1**: AI を使わないので、**コストが 0 円**。
*   **メリット2**: AI の計算時間がないので、**爆速 (ミリ秒)** で回答。

---

## 4. 実践編：よくある 3 つの活用ケーススタディ

ここでは、実際の企業でよくある悩みと、APIM を使った解決策を紹介します。

### 🏢 ケース A：社内 ChatGPT の導入
**～「全部署に配りたいけど、総務部だけ使いすぎて予算オーバーしたら困る！」～**

*   **課題**: 全社員に開放したいが、特定の部署が使いすぎて、会社全体の予算 (または Azure の制限枠) を食いつぶしてしまうのが怖い。
*   **APIM ソリューション**: **「部署ごとのサブスクリプション & クォータ制限」**
*   **構成**:
    *   **商品 (Product)**: 「人事部用プラン」「開発部用プラン」を作成。
    *   **ポリシー**: 各プランに「月間 100万トークンまで (Token Limit Policy)」を設定。
*   **結果**: 開発部が上限に達しても、人事部は影響を受けずに使い続けられる。コスト管理が部署単位で明確になる。

### 🌍 ケース B：グローバル顧客サポートボット
**～「24時間365日、絶対に止まってはいけない！」～**

*   **課題**: コールセンターの自動応答に AI を使う。もし AI が「混雑中」で止まったら、クレームに繋がる。絶対にダウンタイムを防ぎたい。
*   **APIM ソリューション**: **「マルチリージョン・ロードバランシング」**
*   **構成**:
    *   **バックエンド**: 米国、欧州、アジアの 3 拠点の Azure OpenAI を登録。
    *   **ロジック**: 「ラウンドロビン (順番)」または「優先度順 (Priority)」で振り分け。
    *   **サーキットブレーカー**: エラーが続いたリージョンは自動的に切り離し、回復したら戻す。
*   **結果**: あるリージョンで障害が起きても、他のリージョンが引き継ぐため、サービスは止まらない。

### 🛡️ ケース C：機密情報の流出防止
**～「うっかり個人情報を AI に送ったらどうしよう…」～**

*   **課題**: 社員が誤って「顧客の電話番号」や「マイナンバー」をプロンプトに入力してしまうリスクがある。
*   **APIM ソリューション**: **「カスタムポリシーによるコンテンツフィルター」**
*   **構成**:
    *   **ポリシー**: リクエスト本文 (Body) を検査する正規表現 (Regex) を設定。
    *   **アクション**: 「090-...」のようなパターンが見つかったら、AI に送る前に APIM がその場でエラー (400 Bad Request) を返す。
*   **結果**: AI 側にデータが渡る前にブロックされるため、情報漏洩リスクを未然に防げる。(※より高度なチェックには Azure AI Content Safety の併用も推奨)

---
(続く：次章「手順編：ゼロから始める AI プロキシ構築ステップ」へ)

---

## 5. 手順編：ゼロから始める AI プロキシ構築ステップ

ここでは、最も基本的な**「Azure OpenAI の前に APIM を置き、トークン制限をかける」**という構成を、ステップバイステップで作ってみましょう。

### 🛠️ 事前準備
*   Azure ポータルにアクセスできること
*   「Azure OpenAI Service」のリソースが作成済みであること (モデル：gpt-35-turbo などがデプロイされていること)

### STEP 1: APIM リソースの作成
1.  Azure ポータルの検索バーで「API Management」を検索し、作成を選択。
2.  **プラン選び**: 検証なら「Developer (開発者)」プラン、本番なら「Standard v2」などを選択。(※AI Gateway 機能の一部はプランに依存するため注意)
3.  作成ポチッ (※完了まで 30～60 分ほどかかります。気長に待ちましょう)

### STEP 2: Azure OpenAI を API として取り込む
1.  APIM の管理画面を開き、左メニューから **[API]** を選択。
2.  **[+ Add API]** をクリックし、**「Azure OpenAI Service」**のアイコンを選択。(これだけで自動インポート機能が動きます！)
3.  対象の Azure OpenAI リソースを選ぶと、自動的にエンドポイント情報などが読み込まれます。
4.  **[Create]** をクリック。これで APIM の中に「Azure OpenAI への通り道」が出来上がりました。

### STEP 3: トークン制限ポリシーの設定
いよいよ「制限」をかけます。

1.  作成した API を選択し、**[Design]** タブを開きます。
2.  **[All operations]** を選択し、**「Inbound processing (受信側処理)」**の **[</>] (コードエディタ)** ボタンをクリック。
3.  以下の XML 構成を追加します。(※これがポリシーの正体です)

```xml
<policies>
    <inbound>
        <base />
        <!-- 1分間に 1000 トークンまでに制限 -->
        <azure-openai-token-limit 
            counter-key="@(context.Subscription.Id)" 
            tokens-per-minute="1000" 
            estimate-prompt-tokens="true" />
    </inbound>
    ...
</policies>
```
*   `counter-key`: 誰ごとにカウントするか (ここではサブスクリプションIDごと)。
*   `tokens-per-minute`: 上限値。

### STEP 4: 動作確認
1.  **[Test]** タブに移動します。
2.  適当なプロンプトを入力して **[Send]**。
3.  最初は `200 OK` で返ってきます。
4.  連打してみましょう。上限 (1000トークン) を超えた瞬間、ステータスコード **`429 Too Many Requests`** が返ってくれば成功です！

---

## 6. 運用編：セキュリティとコスト管理のベストプラクティス

より安全に、長期間運用するためのプロの知恵です。

### 🔑 API キーの管理 (Managed Identity)
コードの中に `api-key: "sk-..."` と書くのはやめましょう。流出の原因です。
*   APIM と Azure OpenAI の間は、**「マネージド ID (Managed Identity)」**を使って認証します。ID もパスワードも存在しないため、盗まれるリスクがありません。
*   APIM のポリシーで `<authentication-managed-identity ... />` を一行入れるだけで設定できます。

### 📊 監視と分析 (App Insights)
「誰がどんな質問をしているか」を知りたい場合、**Application Insights** を APIM に接続します。
ただし、デフォルトでは「本文 (プロンプトの中身)」まではログに残りません。
*   監査が必要な場合は、**「ログ設定」で詳細ログをオン**にします。
*   (※注意：個人情報などが見えてしまうため、閲覧権限は厳しく管理しましょう)

### 💰 コストアラート
APIM の制限機能は強力ですが、念のため Azure の **[Cost Management]** で「予算アラート」を設定しましょう。「予算の 80% に達したら管理者にメール」という設定をしておけば、万が一の際も安心です。

---

## 7. よくある質問 (Q&A)

### Q1: APIM を入れると遅くなりませんか？
**A: ほぼ無視できるレベルです。**
APIM の処理時間は数ミリ秒～数十ミリ秒程度です。AI の生成時間 (数秒) に比べれば誤差の範囲です。むしろ Semantic Cache がヒットすれば劇的に速くなります。

### Q2: 既存のアプリの変更は必要ですか？
**A: 接続先 (エンドポイント) の変更だけ必要です。**
今まで `https://my-openai.openai.azure.com/...` に投げていたのを、`https://my-apim.azure-api.net/...` に変えるだけです。中身のパラメータ等はそのまま使えます。

### Q3: 導入コストは高いですか？
**A: ピンキリですが、小規模なら安価です。**
開発者版 (SLAなし) は安価ですが、本番運用には Standard v2 や Premium が推奨されます。AI 導入による「青天井の請求」のリスクを保険としてカバーすると考えれば、十分に元が取れる投資です。

---

## さいごに

AI 導入は「作って終わり」ではありません。**「作ってからどう統制するか」**が本当の勝負です。
Azure APIM という強力な門番を味方につけて、安心・安全な AI 活用ライフをスタートさせてください！
