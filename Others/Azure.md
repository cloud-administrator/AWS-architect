# AZ-104 試験対策：コンピューティングサービス完全攻略ガイド

この記事は、Microsoft Azure Administrator (AZ-104) 認定試験の受験者、特に**初学者**の方を対象に、コンピューティング分野の主要サービスを網羅的に解説した学習資料です。
試験で問われるポイント、勘違いしやすい「引っ掛け」ポイント、そして実務でも役立つ知識を、**見やすく・わかりやすく**整理しています。

---

## 📖 目次

1. [Azure Virtual Machines (VM)](#1-azure-virtual-machines-vm)
2. [Virtual Machine Scale Sets (VMSS)](#2-virtual-machine-scale-sets-vmss)
3. [Azure App Service](#3-azure-app-service)
4. [Azure Container Instances (ACI)](#4-azure-container-instances-aci)
5. [Azure Kubernetes Service (AKS)](#5-azure-kubernetes-service-aks)
6. [Azure Functions](#6-azure-functions)

---

## 1. Azure Virtual Machines (VM)

**Azure Virtual Machines (VM)** は、物理的なサーバーをエミュレート（模倣）した IaaS (Infrastructure as a Service) サービスです。OS（Windows や Linux）から上の管理はユーザーの責任となります。

### ✅ 基本概念と特徴
*   **制御権**: OS レベルまで完全に制御可能（RDP/SSH 接続が可能）。カスタムソフトウェアのインストールも自由。
*   **課金モデル**: 従量課金制（秒単位）。VM を「停止（割り当て解除）」している間は、コンピュート料金は発生しません（ただし、ディスク料金は発生し続けるので注意！）。

> [!IMPORTANT]
> **試験の超重要ポイント：停止と割り当て解除**
> *   **OS内でシャットダウン**：「停止」状態だが、Azure リソースとしては確保されたまま。→ **課金される**。
> *   **Azure Portal で停止**：「停止（割り当て解除）」状態。リソースが解放される。→ **コンピュート料金は課金されない**。
> *   ※試験では「コストを削減するためにどうするか？」という問いで頻出です。「OS内でのシャットダウン」を選ばないように！

### 🛡️ 可用性オプション (Availability Options)
VM の可用性（SLA: Service Level Agreement）を高めるための構成です。**試験の最重要エリア**の一つです。

| オプション | 概要 | SLA (最大) | 障害への耐性 |
| :--- | :--- | :--- | :--- |
| **単一 VM (Premium SSD)** | オプションなしで Premium SSD ストレージを使用 | 99.9% | なし（ハードウェア障害やメンテで停止あり） |
| **可用性セット (Availability Sets)** | データセンター内でラックを分散させる | 99.95% | ラック障害（電源・ネットワーク）など |
| **可用性ゾーン (Availability Zones)** | リージョン内でゾーン（物理的な建物）を分ける | 99.99% | データセンター全体の障害（火災・停電など） |

#### 1. 可用性セット (Availability Sets)
同一データセンター内で、物理的に異なる場所に VM を配置する機能です。以下の2つの要素で構成されます。

*   **障害ドメイン (Fault Domain: FD)**:
    *   電源とネットワークスイッチを共有するグループ（サーバーラック）。
    *   FD を分けることで、1つのラックがダウンしても他の VM は生き残る。
    *   最大 **3** つまで設定可能。
*   **更新ドメイン (Update Domain: UD)**:
    *   メンテナンスや再起動が同時に行われないグループ。
    *   UD が異なれば、同時にメンテナンス再起動されることはない。
    *   最大 **20** まで設定可能。

> [!CAUTION]
> **引っ掛け注意！**
> 可用性セットは「データセンター障害（災害など）」には対抗できません。同じデータセンター内にいるからです。データセンター全滅に備えるなら「可用性ゾーン」が必要です。

#### 2. 可用性ゾーン (Availability Zones)
1つの Azure リージョン（例：東日本）の中に存在する、独立した電源・冷却・ネットワークを持つ物理的なロケーション（建物郡）です。
*   **Zone 1, Zone 2, Zone 3** のように番号で指定して VM を配置します。
*   **ゾーン冗長 (Zone Redundant)**: サービスが自動的にゾーンをまたいで複製されること（VM では手動で配置が必要）。

### 💾 ディスクストレージ
VM にアタッチするディスクには大きく分けて2種類あります。現在は**Managed Disks**が主流です。

1.  **管理ディスク (Managed Disks)**:
    *   Microsoft がバックエンドのストレージアカウントを管理。可用性が高く、管理が楽。**基本はこちらを選ぶ。**
2.  **非管理ディスク (Unmanaged Disks)**:
    *   ユーザーが自分でストレージアカウントを作成・管理が必要。古い仕様。

#### ディスクの種類 (SKU)
パフォーマンス要件に応じて選択します。

*   **Ultra Disk**: 最速。ミリ秒未満のレイテンシ。IOPS とスループットを動的に変更可能。
*   **Premium SSD**: 本番環境向け。高い IOPS とスループット。SLA 対象。
*   **Standard SSD**: 安価な開発・テスト、Web サーバー向け。
*   **Standard HDD**: バックアップやアクセスの少ないデータ向け。

> [!TIP]
> **試験対策**：
> 「SLA 99.9% (単一VM) を達成するための最小要件は？」と聞かれたら、**Premium SSD** 以上が必須です。Standard HDD では単一 VM の SLA は提供されません。

### 🌐 ネットワーク構成
VM には直接 IP アドレスが付くわけではなく、**ネットワークインターフェース (NIC)** がアタッチされます。
*   **パブリック IP**: インターネットから接続する場合に必要。
*   **プライベート IP**: 仮想ネットワーク (VNet) 内での通信用。
*   **NSG (Network Security Group)**: ファイアウォールのようなもの。ポート（RDP: 3389, SSH: 22, HTTP: 80 等）の許可/拒否を設定。NIC または サブネットに関連付け可能。

---

## 2. Virtual Machine Scale Sets (VMSS)

**Virtual Machine Scale Sets (VMSS)** は、負荷分散された同一の VM のグループを作成・管理できるサービスです。
「負荷に応じて VM の台数を自動で増減させたい（オートスケーリング）」という要件があれば、VMSS を選択します。

### ✅ 基本機能
*   **オートスケーリング**: CPU 使用率やメモリ使用量、スケジュールのメトリクスに基づいて、VM インスタンスの数を自動的に増やす（スケールアウト）または減らす（スケールイン）ことができます。
*   **負荷分散**: Azure Load Balancer や Application Gateway と自動的に統合されます。
*   **高可用性**: 複数の可用性ゾーンにまたがって VM を展開できます。

### ⚙️ オーケストレーションモード
VMSS には2つのモードがあります。試験で問われる可能性があります。

1.  **Uniform (均一)**:
    *   すべての VM インスタンスが「同じイメージ、同じ構成」で作成されます。
    *   従来の VMSS の動作です。大量の VM を素早く展開するのに向いています。
2.  **Flexible (フレキシブル)**:
    *   通常の VM と同様に個々の VM を制御しながら、スケーリング機能を利用できます。
    *   **重要**: 耐障害性を高めるために、FD (障害ドメイン) を手動で分散させるような高度な構成が可能です。

### 🔄 更新ポリシー (Upgrade Policies)
OS イメージの更新やパッチ適用をどう行うかという設定です。

| ポリシー | 説明 |
| :--- | :--- |
| **手動 (Manual)** | 自動では行われません。管理者が手動で更新をトリガーする必要があります。**デフォルトの設定**です。 |
| **自動 (Automatic)** | Azure がタイミングを見て自動的に更新します。ダウンタイムが発生しないように順次行われます。 |
| **ローリング (Rolling)** | 更新をバッチ（グループ）に分けて順次適用します。「全体の 20% ずつ更新する」といった詳細な制御が可能です。 |

> [!WARNING]
> **引っ掛けポイント**
> 「VMSS を作成したが、OS イメージを更新してもインスタンスに反映されない。なぜか？」
> → 答え：更新ポリシーが**Manual (手動)** になっているからです。手動モードの場合、`Reimage` (再イメージ化) や `Upgrade` アクションを実行しない限り、既存の VM には変更が反映されません。

---

## 3. Azure App Service

**Azure App Service** は、Web アプリケーション、REST API、モバイルバックエンドをホストするための PaaS (Platform as a Service) です。
OS の管理（パッチ適用など）は Microsoft が行います。開発者はコードのデプロイに集中できます。

### 📦 App Service Plan (ASP)
App Service を動かすための「サーバーファーム（サーバーの集まり）」の定義です。**料金と機能**はここで決まります。
リージョンと OS (Windows/Linux) を指定します。

#### 主な価格帯 (SKU) と機能
試験では「この機能を使うにはどのプランが必要か？」が問われます。

| SKU (プラン) | 用途 | 特徴・制限 | デプロイスロット | VNet 統合 |
| :--- | :--- | :--- | :--- | :--- |
| **Free / Shared** | 趣味・学習 | 共有インフラ。SLA なし。カスタムドメイン可(Shared)。 | ❌ なし | ❌ 不可 |
| **Basic** | 小規模開発 | 専用インスタンス。SSL 対応。 | ❌ なし | ❌ 不可 |
| **Standard** | **本番環境 (小)** | オートスケール、バックアップ、スロット対応。 | ✅ あり (5) | ✅ 可能 |
| **Premium (V2/V3)** | **本番環境 (大)** | 高性能、大規模スケール、ゾーン冗長対応。 | ✅ あり (20) | ✅ 可能 |
| **Isolated** | 大規模・高隔離 | **App Service Environment (ASE)** 専用。VNet 内に閉域配置可能。 | ✅ あり | ✅ 可能 |

> [!TIP]
> **試験対策：最低要件の法則**
> *   「デプロイスロットを使いたい」→ 最小は **Standard**。
> *   「VNet 統合を使いたい（オンプレミスと接続したい）」→ 最小は **Standard**。
> *   「プライベートな環境で完全に隔離したい」→ **Isolated (ASE)**。

### 🚀 デプロイスロット (Deployment Slots)
本番環境（Production）とは別に、「Staging」などのスロットを作成し、そこで動作確認を行えます。
*   **スワップ (Swap)**: スロットと本番環境を瞬時に入れ替える機能。ダウンタイムなしでリリース可能（VIP スワップ）。
*   **トラフィック分割**: 「10% のユーザーだけ新しいスロットに流す」といったカナリアリリースが可能。

### 📈 スケーリング
*   **スケールアップ (Scale Up)**: プランのランクを上げる（例：Standard → Premium）。CPU/メモリを増強。
*   **スケールアウト (Scale Out)**: インスタンス数を増やす。負荷分散。
    *   **自動スケール**: CPU % やメモリ量に応じて自動で台数を増減。Standard 以上で利用可能。

---

## 4. Azure Container Instances (ACI)

**Azure Container Instances (ACI)** は、Azure 上でコンテナを実行するための最もシンプルで高速な方法です。「サーバーレスコンテナ」とも呼ばれます。

### ✅ 特徴とユースケース
*   **仮想マシン管理不要**: VM を立てたり管理したりする必要はありません。コンテナイメージ（Docker Image）を指定するだけで起動します。
*   **高速起動**: 数秒で起動可能。
*   **課金**: 秒単位の課金。
*   **ユースケース**:
    *   簡単なバッチ処理。
    *   開発・テスト環境。
    *   一時的なタスク（CI/CD ビルドエージェントなど）。
    *   オーケストレーション（管理機能）が不要な場合。

### 👥 コンテナグループ
ACI では、単一のホストマシン上で複数のコンテナをまとめて実行する「コンテナグループ」という概念があります。
*   これらはライフサイクル（起動・停止）、ローカルネットワーク、ストレージボリュームを共有します。
*   **サイドカーパターン**: メインのアプリコンテナの横に、ログ収集や監視用の補助コンテナを置く構成に適しています。

> [!CAUTION]
> **ACI の制限**
> ACI は「スケーリング」や「高度な負荷分散」、「自己修復（オートヒーリング）」などのオーケストレーション機能を持ちません。これらが必要な場合は、次に紹介する **AKS** を使用します。

---

## 5. Azure Kubernetes Service (AKS)

**Azure Kubernetes Service (AKS)** は、コンテナオーケストレーションツールである Kubernetes (K8s) のマネージドサービスです。
大量のコンテナを運用、自動スケーリング、自己修復させる場合はこちらを選択します。

### 🏗️ アーキテクチャ
AKS は「コントロールプレーン（管理機能）」と「ノード（実行環境）」に分かれています。

1.  **コントロールプレーン (Master Node)**:
    *   Microsoft が管理。**無料**です。（SLA 付きの Standard Tier を選ぶと有料）。
    *   API Server, Scheduler, etcd などが含まれます。
2.  **ノード (Worker Node)**:
    *   ユーザーのアプリケーションが動く VM。**有料**です（VM の料金がかかります）。
    *   **ノードプール**: 同じ構成の VM のグループ。Windows ノードプールと Linux ノードプールを混在させることも可能です。

### 📈 スケーリングの種類
試験でよく出る Kubernetes のスケーリング用語です。

*   **HPA (Horizontal Pod Autoscaler)**:
    *   Pod（コンテナ）の数を増やす。CPU 使用率などに基づいて自動化。
*   **Cluster Autoscaler**:
    *   Node（VM）の数を増やす。Pod を配置する場所が足りなくなったときに動作。
*   **ACI との連携 (Virtual Kubelet)**:
    *   急激なバーストアクセス時に、足りない分を ACI (Azure Container Instances) に逃がす構成が可能。これを **Virtual Nodes** と呼びます。

### 🔄 アップグレード
AKS クラスター（Kubernetes のバージョン）のアップグレードは Azure Portal や CLI から簡単に行えます。
*   **Cordon & Drain**: アップグレード中、Azure は自動的にノードを「Cordon（新規配置禁止）」し、「Drain（既存 Pod の追い出し）」を行ってから VM を更新します。これによりダウンタイムを最小限にします。

---

## 6. Azure Functions

**Azure Functions** は、イベントドリブン（イベント駆動型）のサーバーレスコンピューティングサービスです。
「何かが起きたら（トリガー）、コードを実行する」という仕組みです。

### ⚡ トリガーとバインディング
*   **トリガー (Trigger)**: 関数を実行させるきっかけ。
    *   例：HTTP リクエスト、タイマー（スケジュール）、Blob ストレージへのファイルアップロード、Service Bus キューのメッセージ着信。
*   **バインディング (Binding)**: データの入出力を簡単にする仕組み。
    *   コード内で DB 接続処理などを書かかなくても、設定だけで Cosmos DB 等にデータを書き込める（出力バインディング）。

### 💰 ホスティングプラン (Hosting Plans)
関数の実行環境と課金体系を決定します。**試験の超頻出ポイント**です。

| プラン | 課金 | 特徴・制限 | コールドスタート | VNet 統合 |
| :--- | :--- | :--- | :--- | :--- |
| **従量課金 (Consumption)** | 実行回数・時間 | 最も安い。自動スケール。**タイムアウト**（デフォルト5分、最大10分）。 | **あり** (発生する) | ❌ 不可 |
| **Premium (Elastic Premium)** | 固定費 (vCPU/メモリ) | 常にウォームスタンバイ（コールドスタートなし）。VNet 統合可能。実行時間無制限（60分保証）。 | **なし** | ✅ 可能 |
| **App Service Plan (Dedicated)** | VM 料金 | App Service (Web Apps) とリソースを共有したい場合に使用。 | なし | ✅ 可能 |

> [!IMPORTANT]
> **試験対策：どのプランを選ぶ？**
> *   「コストを最小限にしたい」→ **従量課金**。
> *   「10分以上かかる長い処理を実行したい」→ **Premium** または **Dedicated**。
> *   「VNet 内のリソースにアクセスしたい」→ **Premium** または **Dedicated**。
> *   「コールドスタート（最初の実行が遅い現象）を避けたい」→ **Premium** または **Dedicated**。

### ⏳ Durable Functions
ステートフル（状態を持つ）な関数を定義するための拡張機能です。
*   **オーケストレーター関数**: 複数の関数（アクティビティ）を順番に呼んだり、並列実行して結果を待ったりするワークフローをコードで記述できます。
*   **ファンアウト/ファンイン**: 1つの処理を複数に並列化し(Fan-out)、最後に集計する(Fan-in)パターンが得意。

---

## 📝 まとめ：コンピュートサービスの使い分けガイド

| 要件 | 推奨サービス |
| :--- | :--- |
| **OS の完全な制御が必要** / 既存アプリの移行 (Lift & Shift) | **Virtual Machines (VM)** |
| **負荷に応じて VM を自動増減**させたい | **VM Scale Sets (VMSS)** |
| **Web アプリ/API** を手軽に公開したい (PaaS) | **App Service** |
| **コンテナ**を最速で動かしたい / オーケストレーション不要 | **ACI (Container Instances)** |
| 大規模な**コンテナ**システム / K8s エコシステムを利用したい | **AKS (Kubernetes Service)** |
| **イベント**に反応して短時間のコードを実行したい / サーバーレス | **Azure Functions** |

---

 
 
# AZ-104 試験対策：ストレージサービス完全攻略ガイド

この記事は、Microsoft Azure Administrator (AZ-104) 認定試験対策として、**Azure Storage** 分野を徹底解説した学習資料です。
複雑になりがちな冗長性オプションや、Blob のアクセス層、ファイル同期ソリューションなどを、**初学者にもわかりやすく**図解的な表現で整理しています。

---

## 📖 目次

1. [Azure Storage Account の基礎](#1-azure-storage-account-基礎)
2. [データの冗長性 (Redundancy)](#2-データの冗長性-redundancy)
3. [セキュリティとアクセス制御](#3-セキュリティとアクセス制御)
4. [Azure Blob Storage](#4-azure-blob-storage)
5. [Azure Files & Azure File Sync](#5-azure-files--azure-file-sync)
6. [その他ストレージ (Queue, Table, Disk)](#6-その他ストレージ-queue-table-disk)
7. [データ転送ツール](#7-データ転送ツール)

---

## 1. Azure Storage Account の基礎

**Azure Storage Account** は、Azure の各種データサービス（Blob, File, Queue, Table）をまとめて管理するための「器（コンテナ）」です。

### 🔑 重要概念
*   **一意な名前**: ストレージアカウント名は、**Azure 全体（全世界）で一意**である必要があります。
    *   形式: 小文字の英数字のみ、3〜24文字。
    *   エンドポイント例: `https://<accountname>.blob.core.windows.net`
*   **アカウントの種類 (Account Kinds)**:
    *   **StorageV2 (General Purpose v2)**: **推奨**。最新機能（階層化、冗長性など）をすべてサポート。
    *   **Storage (General Purpose v1)**: レガシー。基本的には使用しないが、非常に古いシステムとの互換性で残っている。
    *   **BlobStorage**: レガシー。現在は StorageV2 を使用すべき。
    *   **BlockBlobStorage / FileStorage**: **Premium パフォーマンス**が必要な場合に選択する特殊なアカウント。

> [!TIP]
> **試験対策**
> 「最新の機能を使用し、コストを最適化したい」という要件があれば、迷わず **StorageV2 (General purpose v2)** を選択してください。V1 や BlobStorage を選ぶ理由は現在ほぼありません。

---

## 2. データの冗長性 (Redundancy)

データセンターの障害からデータを守るための仕組みです。**AZ-104 試験で最も出題される（そしてややこしい）分野**の一つです。
「どの障害まで耐えられるか」「クロスリージョンレプリケーション（地域間複製）はあるか」を表で覚えましょう。

### 🛡️ 冗長性オプション一覧

| オプション | 正式名称 (Full Name) | データのコピー数 | データの場所 | 耐障害性 |
| :--- | :--- | :--- | :--- | :--- |
| **LRS** | **Locally Redundant Storage**<br>(ローカル冗長ストレージ) | 3コピー | 1つのデータセンター内 | ラック/サーバー障害 |
| **ZRS** | **Zone-redundant Storage**<br>(ゾーン冗長ストレージ) | 3コピー | 同ーリージョン内の<br>**3つの可用性ゾーン** | データセンター障害<br>(火災・停電) |
| **GRS** | **Geo-redundant Storage**<br>(ジオ冗長ストレージ) | 6コピー | プライマリリージョン(LRS)<br>+ セカンダリリージョン(LRS) | **リージョン障害**<br>(大地震・洪水) |
| **GZRS** | **Geo-zone-redundant Storage**<br>(ジオゾーン冗長ストレージ) | 6コピー | プライマリリージョン(**ZRS**)<br>+ セカンダリリージョン(LRS) | データセンター障害 +<br>リージョン障害 |

### ⚠️ フェイルオーバーと読み取りアクセス

GRS や GZRS は、データを数百キロ離れた「ペアリージョン（例：東日本 ↔ 西日本）」にコピーします。しかし、デフォルトでは**セカンダリリージョンのデータにはアクセスできません**。

*   **セカンダリへのアクセス権**:
    *   通常時：プライマリのみ読み書き可能。
    *   障害時：Microsoft がフェイルオーバーを発動しない限り、セカンダリは読めない。
*   **RA-GRS / RA-GZRS (Read Access - ...)**:
    *   **重要**: オプション名の頭に `RA-` (Read Access) がつくと、**通常時でもセカンダリからデータの「読み取り」が可能**になります。
    *   書き込みは常にプライマリのみ。
    *   ユースケース：プライマリがダウンしても、セカンダリから読み取ることでサービスの稼働を継続したい場合。

> [!IMPORTANT]
> **試験の引っ掛けポイント：ZRS から GRS への変換**
> 既存のストレージアカウントのレプリケーション設定を変更する場合、**LRS ↔ GRS** は直接変更可能です。
> しかし、**LRS ↔ ZRS** の直接変更は（基本的には）できません。データの移行（コピー）が必要になるケースが多いです。（※一部リージョンでライブマイグレーションがサポートされ始めていますが、試験的には「ZRSへの変更は制約が多い」と覚えておくのが安全です。）

---

## 3. セキュリティとアクセス制御

ストレージへのアクセスを「誰に」「どのように」許可するか。3つの主要な方法があります。

### 🔑 1. アクセスキー (Storage Account Keys)
*   **概要**: 管理者権限（フルアクセス）を持つ2つの鍵（Key1, Key2）。
*   **リスク**: これが漏れると、すべてのデータを操作・削除できてしまうため、**アプリケーションへの埋め込みは非推奨**。
*   **運用**: 定期的に鍵をローテーション（交換）するために2つ用意されている。KeyVault に格納して管理するのがベストプラクティス。

### 🎫 2. 共有アクセス署名 (SAS: Shared Access Signature)
*   **概要**: アクセスキーを使わずに、**「期間」「権限」「IPアドレス」などを制限した一時的なアクセスURL**を発行する機能。
*   **試験頻出パラメータ**:
    *   **Allowed Services**: Blob, File, Queue, Table のどれを許可するか。
    *   **Allowed Resource Types**: Service(アカウント全体), Container(フォルダ), Object(ファイル)。
    *   **Allowed Permissions**: Read, Write, Delete, List, Add, Create, Update, Process。
    *   **Start/Expiry time**: 有効期限。
*   **ユーザー委任 SAS (User Delegation SAS)**:
    *   Entra ID (旧 Azure AD) の資格情報を使って署名する SAS。アカウントキーを使わないため、よりセキュア。

### 🆔 3. Microsoft Entra ID (旧 Azure AD) 認証
*   **概要**: ユーザーやマネージド ID に対して RBAC (ロールベースアクセス制御) で権限を割り当てる。**最も推奨される方法**。
*   **ロールの例**:
    *   **Storage Blob Data Owner**: コンテナ作成、データ読み書き、権限変更（フルアクセス）。
    *   **Storage Blob Data Contributor**: データの読み書きはできるが、権限変更はできない。
    *   **Storage Blob Data Reader**: データの読み取りのみ。

> [!CAUTION]
> **よくある間違い：Contributor (共同作成者) ロール**
> `Contributor` (Azure リソース自体の管理者) ロールを持っていても、**データプレーン（Blobの中身）へのアクセス権はありません**。
> 「ストレージアカウントの設定は変更できるが、Blob ファイルが見れない」というトラブルシュート問題の正解は、「**Storage Blob Data Contributor** ロールを付与する」です。

### 🌐 ネットワークセキュリティ
*   **ファイアウォール**: 指定した IP アドレス範囲または VNet からのみアクセスを許可。
*   **プライベートエンドポイント**: VNet 内にプライベート IP を持ち、インターネットを経由せずに閉域網でストレージにアクセスする技術。

---

## 4. Azure Blob Storage

**Azure Blob Storage** は、テキストやバイナリデータ（画像、動画、ログファイルなど）を大量に保存するためのオブジェクトストレージです。AWS S3 に相当します。

### 📦 構造
1.  **Storage Account**: 最上位の親。
2.  **Container**: フォルダのようなもの。Blob をグループ化。アクセス権設定の境界。
3.  **Blob**: 実際のファイル。

### 📊 アクセス層 (Access Tiers)
データの利用頻度に応じてコストを最適化するための設定です。**試験でのコスト計算・最適化問題の主役**です。

| アクセス層 | 用途 | ストレージ料金 | アクセス料金 | データの可用性 | 変更可能性 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **Hot** (ホット) | 頻繁にアクセスされるデータ。<br>（Web画像、現在進行形のログ） | 高い | **安い** | 即時 | オンライン変更可 |
| **Cool** (クール) | **30日以上**保存。たまにしかアクセスしない。<br>（先月のバックアップ、古いプロジェクト） | 中くらい | 中くらい | 即時 | オンライン変更可 |
| **Cold** (コールド) | **90日以上**保存。Cool よりさらにアクセス頻度が低い。 | 安い | 高い | 即時 | オンライン変更可 |
| **Archive** (アーカイブ) | **180日以上**保存。滅多に使わない。<br>（法的保存義務のある数年前のログ） | **最安** | **最高** | **非オフライン**<br>(取り出しに時間がかかる) | **アクセス不可**<br>(リハイダレートが必要) |

> [!WARNING]
> **試験対策：アーカイブ層からの復元 (Rehydration)**
> Archive 層にあるデータは直接読み取れません。Hot または Cool 層に戻す「リハイダレート」操作が必要です。
> *   **標準 (Standard)**: 完了まで最大 **15時間**。安い。
> *   **優先 (High Priority)**: 完了まで **1時間以内**（通常数分）。高い。
> 「緊急でデータが必要になった！」というシナリオでは「優先」を選びます。

### 🔄 ライフサイクル管理 (Lifecycle Management)
「ルール」を作成して、自動的にアクセス層を移動させたり、削除したりする機能です。
*   例：「作成から30日経過したら Cool に移動」「1年経過したら Archive に移動」「7年経過したら削除」
*   **LastAccessTime (最終アクセス時間)**: 有効にすると、「最後に**読まれた**日」を基準に移動できます（デフォルトは「作成日」や「更新日」基準）。

### 🔒 不変ストレージ (Immutable Storage)
「WORM (Write Once, Read Many)」を実現する機能。一度書き込んだら、指定期間は**管理者であっても変更・削除ができなく**なります。
*   **時間ベースの保持ポリシー**: 指定した日数（例：365日）は削除不可。
*   **訴訟ホールド (Legal Hold)**: 明示的に解除されるまで、無期限に削除不可。

---

## 5. Azure Files & Azure File Sync

**Azure Files** は、フルマネージドのファイル共有サービスです。標準の **SMB プロトコル** (Windows/Mac/Linux) や **NFS** (Linux) でマウントできます。

### 💻 利用シナリオ
*   **Lift & Shift**: オンプレミスのファイルサーバーをそのままクラウドに移行したい。
*   **共有設定**: 複数の VM から同時に同じファイルを読み書きしたい。

### 🌲 オンプレミス AD DS 認証
Azure Files は、オンプレミスの Active Directory Domain Services (AD DS) と連携し、**Windows の ACL (アクセス制御リスト)** をそのまま利用できます。
*   これにより、オンプレミスのファイルサーバー移行時に、フォルダごとのアクセス権限設定を維持したまま移行可能です。

### 🔄 Azure File Sync
オンプレミスの Windows Server と Azure Files を同期させるハイブリッドソリューションです。

*   **仕組み**:
    *   オンプレミスのサーバーに「Azure File Sync エージェント」をインストール。
    *   Azure Files を「マスターコピー」として、オンプレミスサーバーを「キャッシュ」として扱います。
*   **クラウド階層化 (Cloud Tiering)**:
    *   **これが最大のメリット**。頻繁に使われるファイルだけをローカルサーバーに残し、使われないファイルは実体を Azure に送ってローカルからはポインタだけ残します（見た目はあるが、開くとダウンロードされる）。
    *   これにより、オンプレミスサーバーのディスク容量を節約できます。

---

## 6. その他ストレージ (Queue, Table, Disk)

### 📨 Queue Storage
*   **用途**: 大量のメッセージを保存するためのサービス。システム間の非同期通信に使用します。
*   **特徴**:
    *   シンプルな構造。
    *   **最大サイズ**: 1メッセージあたり 64 KB。
    *   **順序**: **FIFO（先入れ先出し）は保証されません**。
    *   より高度な機能（Pub/Sub、FIFO保証、トランザクション、256KB以上のメッセージ）が必要な場合は、**Azure Service Bus** を使用します。

### 📊 Table Storage
*   **用途**: NoSQL キーバリューストア。構造化された非リレーショナルデータを大量に保存。
*   **Cosmos DB との違い**:
    *   Table Storage は安価で単純。
    *   グローバル分散、低レイテンシ、マルチ API が必要な場合は **Cosmos DB** を選択します。

### 💿 Azure Disk Storage (Managed Disks)
VM にアタッチされる仮想ディスクです。コンピュートの章でも触れましたが、ストレージ観点での重要ポイントをまとめます。

*   **管理ディスク (Managed Disks)**:
    *   ユーザーは「ディスク」リソースだけを意識すればよく、裏側のストレージアカウント管理は不要。
    *   **冗長性**: LRS または ZRS のみ。（GRS は非対応。リージョンをまたぐ場合は Azure Backup や Site Recovery を使う）。
*   **暗号化**:
    *   **SSE (Server-Side Encryption)**: 保存時に自動暗号化。デフォルトで有効（Platform Managed Keys）。
    *   **ADE (Azure Disk Encryption)**: OS レベル（BitLocker / DM-Crypt）での暗号化。VM の処理能力を使う。

> [!TIP]
> **試験対策：スナップショットとバックアップ**
> *   **スナップショット**: 特定時点のディスクのコピー。差分バックアップではない（フルコピーに近い）。そのままでは VM として起動できず、ディスクを作成し直す必要がある。
> *   **Azure Backup**: 定期的なスケジュール、保持期間管理、整合性確保などが統合されたサービス。運用バックアップにはこちらを使う。

---

## 7. データ転送ツール

データを Azure に移行したり、データを操作したりするためのツールです。**AzCopy のコマンド**は試験に出ます。

### 📋 Azure Storage Explorer
GUI (Graphical User Interface) ツール。Windows, Mac, Linux で動作。
*   ストレージアカウント内のデータをエクスプローラーのように操作できる。
*   Blob のアップロード/ダウンロード/SAS発行などがマウス操作で可能。
*   エミュレータ (Azurite) に接続してローカル開発も可能。

### 💻 AzCopy
コマンドライン (CLI) ツール。**最高のパフォーマンス**でデータをコピー・同期するために最適化されています。

*   **基本構文**:
    ```bash
    azcopy copy '送り元(Source)' '送り先(Destination)' [flags]
    ```
*   **認証**:
    *   Entra ID 認証 (`azcopy login`)
    *   SAS トークン（URLの後ろに付与）
*   **同期 (Sync)**:
    ```bash
    azcopy sync 'ソース' 'デスティネーション' --delete-destination=true
    ```
    *   `sync` コマンドを使うと、変更があったファイルだけを転送（増分コピー）します。
    *   `--delete-destination=true` をつけると、**ソースにないファイルをデスティネーションから削除**します（ミラーリング）。

> [!IMPORTANT]
> **試験の引っ掛け：Import/Export サービス**
> 「数百 TB のデータを、インターネット回線が遅い環境から Azure に移行したい。どうするか？」
> → 答え：**Azure Import/Export サービス** (HDD を物理的に郵送する) または **Azure Data Box** を使用する。
> 「数 TB 程度で、回線はそこそこある」なら **AzCopy**。

---
 
 
# AZ-104 完全攻略ガイド：Azure Network 編

このガイドは、Azure Administrator Associate (AZ-104) 認定試験のネットワーク分野をマスターするために作成されました。
初心者が理解しやすいように、専門用語を丁寧に解説し、試験で頻出の「引っ掛けポイント」や「重要な違い」を強調しています。

---

## 📚 目次

1. [仮想ネットワークの基本 (VNet, Subnet)](#1-仮想ネットワークの基本-vnet-subnet)
2. [名前解決 (Azure DNS)](#2-名前解決-azure-dns)
3. [ネットワーク間の接続 (VNet Peering)](#3-ネットワーク間の接続-vnet-peering)
4. [ネットワークセキュリティ (NSG, ASG, Firewall, Bastion)](#4-ネットワークセキュリティ-nsg-asg-firewall-bastion)
5. [負荷分散技術 (Load Balancer, App Gateway, Traffic Manager)](#5-負荷分散技術-load-balancer-app-gateway-traffic-manager)
6. [ハイブリッド接続 (VPN Gateway, ExpressRoute)](#6-ハイブリッド接続-vpn-gateway-expressroute)
7. [監視とトラブルシューティング (Network Watcher)](#7-監視とトラブルシューティング-network-watcher)

---

## 1. 仮想ネットワークの基本 (VNet, Subnet)

### 概要
**Virtual Network (VNet)** は、Azure上の「あなたの専用のプライベートなネットワーク空間」です。
**Subnet (サブネット)** は、そのVNetをさらに細かく区切った「部屋」のようなものです。

### 🔑 試験での重要ポイント

*   **IPアドレス空間**: VNet作成時にプライベートIPアドレス範囲 (CIDR表記、例: 10.0.0.0/16) を定義します。
*   **サブネット**: VNetのアドレス空間を分割して使用します。
*   **専用サブネット**: 特定のAzureリソースには、**専用の名前を持つサブネット**が必要です。これらは任意の名前を付けてはいけません。
    *   `GatewaySubnet`: VPN Gateway / ExpressRoute Gateway 用
    *   `AzureFirewallSubnet`: Azure Firewall 用
    *   `AzureBastionSubnet`: Azure Bastion 用

### ⚠️ よくある間違い・引っ掛けポイント

> [!WARNING]
> **重複するIPアドレス空間に注意！**
> 2つのVNetを接続 (ピアリング) する場合、**IPアドレス空間が重複していると接続できません**。設計段階で重複しないように計画することが試験でも実務でも重要です。

> [!IMPORTANT]
> **Azureが予約するIPアドレス**
> 各サブネットの最初の4つと最後の1つのIPアドレス (合計5つ) はAzureが予約しており、**使用できません**。
> *   x.x.x.0: ネットワークアドレス
> *   x.x.x.1: デフォルトゲートウェイ
> *   x.x.x.2, x.x.x.3: Azure DNS用マッピング
> *   x.x.x.255: ブロードキャストアドレス
>
> **計算問題の罠**: 「/24 (256個) のサブネットで実際に使えるIPアドレスは？」 → **251個** です。

---

## 2. 名前解決 (Azure DNS)

### 概要
Azure上のリソースが互いに名前 (ホスト名) で通信するための仕組みです。

### 構成要素
1.  **Azure提供のDNS**: 追加設定なしで使える。同じVNet内のVM同士の解決は可能だが、簡易的。
2.  **カスタムDNS**: 自分でDNSサーバーを立てる、またはオンプレミスのDNSを参照する場合に使用。
3.  **Azure Private DNS Zone**: 独自のドメイン名 (例: `internal.corp`) をAzureのプライベートネットワーク内で使えるようにするフルマネージドサービス。

### ⚠️ よくある間違い・引っ掛けポイント

> [!CAUTION]
> **DNS設定変更後の再起動**
> VNetのDNS設定 (Azure提供 → カスタムDNS など) を変更した場合、そのVNet内の**既存のVMは再起動するまで新しいDNS設定を認識しません**。
> 「DNSサーバーを変更したがつながらない、なぜか？」というトラブルシューティング問題の定番です。

> [!TIP]
> **自動登録 (Auto-registration)**
> Azure Private DNS Zone を VNet にリンクする際、**「自動登録」を有効にする**と、そのVNetに仮想マシンを作成した際、自動的にDNSレコード (Aレコード) が作成されます。手動登録の手間が省ける便利な機能として試験に出ます。

---

## 3. ネットワーク間の接続 (VNet Peering)

### 概要
**VNet Peering (ピアリング)** は、2つの異なるVNetを接続し、あたかも1つのネットワークのように通信できるようにする機能です。
インターネットを経由せず、Microsoftのバックボーンネットワークを通るため、**低遅延・広帯域**です。

### 種類
*   **VNet Peering**: 同じリージョン内のVNet同士の接続。
*   **Global VNet Peering**: 異なるリージョン間のVNet同士の接続。

### 🔑 試験での重要ポイント
*   **推移的なルーティング (Transitive Routing) はしない**:
    *   VNet A ↔ VNet B ↔ VNet C とピアリングしていても、**AからCへは直接通信できません**。
    *   AからCへ通信させたい場合、AとCも直接ピアリングする必要があります（メッシュ型）。
    *   例外：Gateway Transit (ゲートウェイ転送) を使う場合（後述）。

### ゲートウェイ転送 (Gateway Transit)
「ハブ＆スポーク」構成で重要です。
*   **Hub VNet** に VPN Gateway があるとします。
*   **Spoke VNet** は Hub VNet とピアリングしています。
*   Spoke VNet の VM が、Hub の VPN Gateway を使ってオンプレミスと通信したい場合設定が必要です。
    *   Hub側設定: **「ゲートウェイ転送を許可する (Allow gateway transit)」**
    *   Spoke側設定: **「リモートゲートウェイを使用する (Use remote gateways)」**

### ⚠️ よくある間違い・引っ掛けポイント

> [!WARNING]
> **アドレス空間の重複**
> 前述の通り、アドレス空間が重複しているVNet同士はピアリングできません。VNet作成後にアドレス空間を追加する場合も、ピアリング相手と重複すると追加できません（ピアリングを一度削除する必要があります）。

---

## 4. ネットワークセキュリティ (NSG, ASG, Firewall, Bastion)

このセクションは試験で最も出題比重が高いエリアの一つです。各サービスの違いを明確にしましょう。

### 4.1 Network Security Group (NSG)

#### 概要
OSI参照モデルの **レイヤー3 (IP) と レイヤー4 (TCP/UDPポート)** でトラフィックをフィルタリングする、基本的なファイアウォールです。

#### 適用先
1.  **サブネット**: サブネット内のすべてのリソースにルールが適用されます（推奨）。
2.  **ネットワークインターフェース (NIC)**: 特定のVM個別に適用されます。

#### 🔑 試験での重要ポイント
*   **ルールの優先順位**: 数字が**小さいほど優先**されます（例: 優先度100のルールは200より先に評価される）。
*   **デフォルトルール**: NSGには既定でいくつかのルールが入っています。
    *   `AllowVNetInBound`: VNet内の通信は許可。
    *   `AllowAzureLoadBalancerInBound`: ロードバランサからのヘルスチェック等は許可。
    *   `DenyAllInBound`: **それ以外はすべて拒否** (これが最後にあるため、許可ルールを明示的に書く必要があります)。

### 4.2 Application Security Group (ASG)

#### 概要
「Webサーバー」「DBサーバー」といった**役割ごと**にVMをグルーピングする機能です。
NSGのルール設定時に、IPアドレスの代わりにASGを指定できます。

#### 💡 メリット (試験に出る理由)
IPアドレスで管理すると、VMが増減するたびにNSGルールのIPリストを更新しなければなりません。
**ASGを使えば、新しいVMをASGに追加するだけで、自動的にセキュリティルールが適用されます**。メンテナンス工数削減の正解選択肢として選ばれます。

### 4.3 Azure Firewall

#### 概要
フルマネージドの、クラウドベースのネットワークセキュリティサービスです。
NSGよりも高度な機能 (**レイヤー7**) を持ちます。

#### NSGとの違い (決定的な違い)

| 機能 | Azure Firewall | NSG |
| :--- | :--- | :--- |
| **OSIレイヤー** | L3, L4, **L7 (アプリケーション)** | L3, L4 |
| **フィルタリング** | FQDN (例: www.google.com) での許可/拒否が可能 | IPアドレス、ポートのみ |
| **スコープ** | VNet全体、または複数のVNet (ハブとして機能) | サブネット、NIC単位 |
| **ステート** | ステートフル (戻り通信を自動許可) | ステートフル |
| **脅威インテリジェンス** | 対応 (既知の悪意あるIP/ドメインをブロック) | 非対応 |
| **SNAT/DNAT** | 対応 | 非対応 |

### 🔑 試験での重要ポイント
*   **FQDNタグ**: `WindowsUpdate` などのタグを使って、OS更新に必要な通信だけを許可することができます（NSGではこれが難しく、サービスラグを使う必要があります）。
*   **DNAT**: インターネットからの通信をプライベートIPへ変換して転送する機能があります。

### 4.4 Azure Bastion

#### 概要
仮想マシン (VM) に安全に RDP/SSH 接続するためのフルマネージドPaaSサービスです。

#### 仕組み
*   ユーザーはブラウザから Azure Portal 経由で Bastion に接続します (**HTTPS/443**)。
*   Bastion は VNet 内からターゲットVMへ RDP(3389) または SSH(22) で接続します。

#### 💡 最大のメリット
**ターゲットVMにパブリックIPアドレスを持たせる必要がありません**。
インターネットにRDPポート(3389)を晒すリスクがなくなります。

#### ⚠️ よくある間違い・引っ掛けポイント

> [!WARNING]
> **AzureBastionSubnet の NSG 要件**
> Azure Bastion を配置するサブネット (`AzureBastionSubnet`) に NSG を適用する場合、**厳しい要件**があります。試験で「接続できない理由」として問われます。
> *   **Inbound**: インターネットからの **443 (HTTPS)** を許可する必要があります（ユーザーのブラウザからのアクセス）。
> *   **Outbound**: ターゲットVMへの **3389/22** を許可する必要があります。
> *   このサブネットには、Bastion以外のリソースを置いてはいけません。

---

## 5. 負荷分散技術 (Load Balancer, App Gateway, Traffic Manager)

Azureには複数のロードバランサがあり、試験では「要件に最適なものはどれか？」を選ぶシナリオ問題が必ず出ます。

### 比較と使い分け (決定版)

| サービス | Load Balancer | Application Gateway | Traffic Manager |
| :--- | :--- | :--- | :--- |
| **OSIレイヤー** | **Layer 4** (TCP/UDP) | **Layer 7** (HTTP/HTTPS) | **DNSベース** (ルーティングのみ) |
| **範囲** | リージョン内 (Regional) | リージョン内 (Regional) | **グローバル** (Global) |
| **トラフィック** | Web以外もOK (DB, RDPなど) | Webトラフィック (HTTP/S) に特化 | 全般 (DNS解決できるもの) |
| **高度な機能** | 単純なハッシュベース分散 | **SSLオフロード**, **WAF**, **URLパスベースルーティング** | 地理的ルーティング, 優先順位付け |
| **プライベートIP** | 対応 (Internal LB) | 対応 | 非対応 (パブリックのみ*例外ありだが基本はパブリック) |

### 5.1 Azure Load Balancer (ALB)
*   **概要**: 非常に高速で低遅延。TCP/UDPレベルで負荷分散します。
*   **SKU**: Basic と Standard がありますが、試験では **Standard** が主流（可用性ゾーン対応、セキュア）。
*   **ヘルスプローブ**: バックエンドVMが生きているか死んでいるかを確認します。これがないとトラフィックが転送されません。

### 5.2 Azure Application Gateway
*   **概要**: Webアプリのための高機能ロードバランサ。
*   **WAF (Web Application Firewall)**: SQLインジェクションやXSSなどの攻撃から保護します。
*   **URLパスベースルーティング**: `Example.com/images/*` は画像サーバーへ、`Example.com/video/*` は動画サーバーへ、といった振り分けが可能。
*   **Cookieベースのセッションアフィニティ**: 「一度繋がったサーバーに接続し続ける」機能があります。

### 5.3 Azure Traffic Manager
*   **概要**: DNSを使って、ユーザーを「最も近いリージョン」や「生きているリージョン」に誘導します。
*   **実体**: 実際のトラフィックはTraffic Managerを経由しません。DNSでお膳立てをするだけです。
*   **ルーティング方法**:
    *   **優先順位 (Priority)**: プライマリ・セカンダリ構成（DR対策）で使用。
    *   **パフォーマンス (Performance)**: ユーザーから最も遅延が少ない場所へ誘導。
    *   **地理的 (Geographic)**: 「ドイツからのアクセスはドイツのリージョンへ」といった法的コンプライアンス対応で使用。

### ⚠️ よくある間違い・引っ掛けポイント

> [!TIP]
> **Load Balancer vs App Gateway の選び方**
> *   「SSLオフロードが必要」「WAFが必要」「URLパスで振り分けたい」「Webアプリ」 → **Application Gateway**
> *   「SQL Serverの負荷分散」「Web以外のプロトコル」「とにかく高速に」「シンプルに」 → **Load Balancer**

> [!WARNING]
> **Traffic Manager vs Front Door**
> どちらもグローバルな負荷分散ですが、最近の試験では **Azure Front Door** も出題されます。
> *   **Traffic Manager**: DNSベース。HTTP以外もOK。
> *   **Front Door**: HTTP/S特化。CDN機能、WAF機能内蔵。より高機能なWeb向けグローバルLB。

---

## 6. ハイブリッド接続 (VPN Gateway, ExpressRoute)

オンプレミスとAzureを接続する方法です。

### 6.1 Azure VPN Gateway
*   **接続方式**: インターネット経由で暗号化トンネル (IPsec/IKE) を張ります。
*   **種類**:
    *   **Site-to-Site (S2S)**: 本社 ↔ Azure VNet の常時接続。
    *   **Point-to-Site (P2S)**: テレワーク社員のPC ↔ Azure VNet の個別接続。
    *   **VNet-to-VNet**: VNet同士をVPNで接続（現在はVNet Peeringが主流）。
*   **SKU**: VpnGw1, VpnGw2... とあり、帯域幅や冗長性が異なります。Zone Redundant (AZ) SKUもあります。

### 6.2 ExpressRoute
*   **接続方式**: インターネットを通らない**専用線**（閉域網）接続。通信事業者 (プロバイダ) との契約が必要。
*   **特徴**:
    *   **高速・低遅延・安定**: インターネットの混雑影響を受けない。
    *   **高セキュリティ**: 公衆網を通らないため安全。
    *   **高コスト**: VPNより高価。
*   **ExpressRoute Global Reach**: 異なるオンプレミス拠点同士を、AzureのExpressRoute回線経由で通信させる機能。

### 比較表 (試験頻出)

| 特徴 | VPN Gateway | ExpressRoute |
| :--- | :--- | :--- |
| **通信経路** | インターネット (暗号化あり) | 専用線 (インターネット不使用) |
| **帯域幅** | 最大 10 Gbps 程度 | 最大 100 Gbps |
| **遅延 (Latency)**| 予測不可 (インターネット依存) | 低遅延・一定 |
| **SLA** | あり | あり (より高いレベル) |
| **導入期間** | 即時 | 数週間〜数ヶ月 (プロバイダ調整必要) |

### ⚠️ よくある間違い・引っ掛けポイント

> [!CAUTION]
> **共存 (Coexistence)**
> VPN Gateway と ExpressRoute は**同じVNetで共存可能**です。
> *   **フェイルオーバー**: ExpressRouteがメイン、切れたらVPN Gatewayへ、というバックアップ構成が可能です。

---

## 7. 監視とトラブルシューティング (Network Watcher)

**Network Watcher** は、特定のリージョンにあるネットワークの監視・診断ツールの集合体です。
試験では「このトラブルにはどのツールを使うべきか？」が問われます。

### 必修ツール 4選

#### 1. IP Flow Verify (IPフローの確認)
*   **用途**: 「VMからインターネットに繋がらない」「特定のポートが通じない」ときに使います。
*   **機能**: NSGのルールをシミュレートして、パケットが **許可 (Allow)** されるか **拒否 (Deny)** されるか、**どのルールによってそうなるか** を教えてくれます。
*   **試験の合言葉**: 「接続できないポートの確認」＝「IP Flow Verify」

#### 2. Next Hop (次ホップ)
*   **用途**: 「パケットがどこに送られているか？」「ルーティングが間違っていないか？」を確認します。
*   **機能**: 特定の宛先IPに対して、次にどこへ転送されるか (Internet, Virtual Appliance, Noneなど) を表示します。
*   **試験の合言葉**: 「ルーティングエラーの調査」「ユーザー定義ルート (UDR) の確認」＝「Next Hop」

#### 3. Connection Monitor (接続モニター)
*   **用途**: 長期間にわたり、A点からB点への接続性や遅延を監視し続けたい場合に使います。
*   **機能**: エージェントを使って継続的にパケットを送り、到達可能性をグラフ化します。

#### 4. NSG Flow Logs (NSGフローログ)
*   **用途**: 「実際にどんな通信が流れたか」の**ログ**を保存・分析したい場合に使います。
*   **機能**: NSGを通過したトラフィックの記録を **Storage Account** に保存します。
*   **分析**: **Traffic Analytics** と組み合わせることで、視覚的なレポート (どの国からアクセスが多いか、など) を作成できます。

### ⚠️ よくある間違い・引っ掛けポイント

> [!TIP]
> **有効化が必要**
> Network Watcher は、使用する **リージョンごとに有効化** する必要があります。

---

## 🏁 まとめと試験へのアドバイス

ネットワーク分野は AZ-104 の中でも配点が高く、かつ実務でも避けて通れない最重要分野です。
特に以下の **「3つの切り分け」** が完璧にできるようになれば、合格は近いです。

1.  **接続の切り分け**: インターネットVPN (VPN Gateway) vs 専用線 (ExpressRoute) vs VNet間 (Peering)
2.  **負荷分散の切り分け**: L4 (Load Balancer) vs L7 (App Gateway) vs Global (Traffic Manager)
3.  **セキュリティの切り分け**: サブネット/NIC守る (NSG) vs グルーピング (ASG) vs 統合管理/L7防御 (Firewall)
4.  **トラブルシューティング**: ポートならIP Flow Verify、ルートならNext Hop。

このガイドを参考に、Azureポータルで実際にリソースを作ってみることを強くお勧めします。
あなたの AZ-104 合格を応援しています！

 
 
# AZ-104 完全攻略ガイド：ID・アクセス管理 (Identity & Access Management)

本ガイドは、Microsoft Azure Administrator (AZ-104) 試験における「ID とアクセス管理」分野を網羅的に解説したものです。
初心者が理解しやすいように図解（アイコン）や表を用い、試験で狙われやすいポイントを「試験の罠」として強調しています。

> [!IMPORTANT]
> **用語について**
> Microsoft は "Azure Active Directory (Azure AD)" を **"Microsoft Entra ID"** に名称変更しました。
> 試験やドキュメントでは新旧の名称が混在する可能性があるため、本ガイドでは「Azure AD (Entra ID)」のように併記、または文脈に応じて Azure AD と記述しますが、**実態は同じもの**として理解してください。

---

## 1. Azure Active Directory (Azure AD / Microsoft Entra ID)

### 1.1 Azure AD の基本概念
Azure AD は、Microsoft のクラウドベースの **ID およびアクセス管理サービス** です。
従来の Windows Server Active Directory (AD DS) とは大きく異なります。

| 特徴 | Windows Server AD (AD DS) | Azure AD (Entra ID) |
| :--- | :--- | :--- |
| **プロトコル** | Kerberos, NTLM, LDAP | HTTP/HTTPS (REST API), SAML, OIDC, OAuth |
| **構造** | 階層型 (OU, ドメイン, フォレスト) | フラット構造 (ユーザーとグループのみ) |
| **管理対象** | オンプレミスのサーバー、PC | クラウドアプリ、Webサービス、デバイス |
| **認証方式** | アカウント認証 | ID プロバイダー (IdP) としての認証 |

#### テナントとサブスクリプションの関係
試験で最も重要な概念の一つです。

*   **テナント (Tenant)**: Azure AD の専用インスタンス。組織（会社）を表します。`*.onmicrosoft.com` ドメインを持ちます。
*   **サブスクリプション (Subscription)**: Azure リソース（VM, Storageなど）の支払いと管理の単位。

> [!WARNING]
> **試験の罠：信頼関係**
> *   **1つのサブスクリプション**は、**必ず1つのテナント**のみを信頼（関連付け）します。
> *   **1つのテナント**は、**複数のサブスクリプション**と紐づくことができます。
> *   サブスクリプションを別のテナントに移行すると、**RBAC (ロール割り当て) はすべて削除**されます。（ユーザーIDが変わるため）

```mermaid
graph TD
    Tenant[Azure AD テナント (Identity)] -->|信頼| Sub1[サブスクリプション C (開発環境)]
    Tenant -->|信頼| Sub2[サブスクリプション A (本番環境)]
    Tenant -->|信頼| Sub3[サブスクリプション B (検証環境)]
    
    style Tenant fill:#e1f5fe,stroke:#01579b
    style Sub1 fill:#fff9c4,stroke:#fbc02d
    style Sub2 fill:#fff9c4,stroke:#fbc02d
    style Sub3 fill:#fff9c4,stroke:#fbc02d
```

### 1.2 ユーザー管理 (Users)

Azure AD のユーザーには主に3つの種類があります。

1.  **クラウド ID (Cloud Identities)**: Azure AD で直接作成されたユーザー。
2.  **ディレクトリ同期 ID (Directory-synchronized Identities)**: オンプレミス AD から Azure AD Connect で同期されたユーザー。
    *   *注意*: 基本的な属性（名前など）はオンプレミス側で管理し、Azure AD 側では変更できません。
3.  **ゲストユーザー (Guest Users / B2B)**: 外部の Azure AD や Microsoft アカウント、Gmail などを持つユーザーを招待したもの。
    *   UserType は `Guest` になります（通常ユーザーは `Member`）。

#### 管理タスク
*   **作成/削除**: Azure Portal, PowerShell, Azure CLI で可能。
*   **一括操作 (Bulk Operations)**:
    *   **CSV ファイル**を使用して、ユーザーの一括作成・削除・招待が可能です。
    *   PowerShell ループ処理を知らなくても Portal から GUI で実行できます。
*   **削除済みユーザーの復元**:
    *   ユーザーを削除すると「削除済みユーザー (Deleted users)」に移動します。
    *   **30日以内**であれば復元可能です。（ゴミ箱機能）

### 1.3 グループ管理 (Groups)

権限管理を効率化するためにグループを使用します。個別ユーザーに権限を割り当てるのは推奨されません（管理が破綻するため）。

#### グループの種類
| 種類 | 説明 | 用途 |
| :--- | :--- | :--- |
| **セキュリティ (Security)** | リソースへのアクセス権管理に使用。 | Azure リソースへの RBAC 割り当てなど。 |
| **Microsoft 365** | コラボレーション用。メールボックス、カレンダー、SharePoint サイトなどが自動作成される。 | Teams や Outlook での共同作業。 |

#### メンバーシップの種類 (割り当てタイプ)
ここが試験の頻出ポイントです。

1.  **割り当て済み (Assigned)**:
    *   管理者が手動で特定のユーザーやグループを追加します。
    *   「静的」なグループです。
2.  **動的ユーザー (Dynamic User)**:
    *   **ルール（クエリ）**に基づいて、自動的にユーザーを追加・削除します。
    *   例: `user.department -eq "Sales"` (部署が Sales のユーザーを自動追加)
    *   *要件*: Azure AD P1 以上のライセンスが必要。
3.  **動的デバイス (Dynamic Device)**:
    *   ルールに基づいて、自動的に**デバイス**を追加・削除します。
    *   例: `device.deviceOSType -eq "Windows"`
    *   *注意*: 動的グループのルールに「ユーザー」と「デバイス」を混在させることはできません。

> [!TIP]
> **動的グループの構文**
> 試験では簡易的なクエリの正誤を問われることがあります。
> *   演算子: `-eq` (等しい), `-ne` (等しくない), `-sw` (～で始まる), `-contains` (～を含む), `-match` (正規表現)
> *   例: `(user.department -eq "HR") -and (user.city -eq "Tokyo")`

### 1.4 デバイス ID (Device Identities)

Azure AD にデバイスを登録することで、条件付きアクセス（会社支給PCのみアクセス許可など）が可能になります。

| 登録タイプ | 対象デバイス | 状態 | 特徴 |
| :--- | :--- | :--- | :--- |
| **Azure AD Registered** (登録済み) | BYOD (個人所有スマホ/PC) | ユーザーが自分のアカウントでサインイン | 組織の管理下には完全には入らないが、SSOなどは利用可能。 |
| **Azure AD Joined** (参加済み) | 会社支給の Windows 10/11 | 組織のアカウントでWindowsにサインイン | クラウド中心の企業向け。オンプレAD不要。 |
| **Hybrid Azure AD Joined** | オンプレAD参加済みの PC | オンプレADとAzure ADの両方に所属 | 既存のオンプレAD環境がある企業向け。GPO管理などが継続可能。 |

> [!IMPORTANT]
> **試験の罠：Hybrid Join の要件**
> Hybrid Azure AD Join を構成するには、**Azure AD Connect** による同期設定が必要です。
> デバイスがインターネット経由で Azure AD に到達できる必要があります。

### 1.5 外部 ID (B2B Collaboration)

他の組織のユーザーをゲストとして招待する機能です。

*   招待されたユーザーは、自分の元の資格情報（Pass）で認証します。Azure AD は認証ロジックを持ちません（**フェデレーション**）。
*   招待状のメールを受け取り、リンクをクリックして承諾（Redeem）プロセスを経ることでアクセス可能になります。
*   **アクセス権**: デフォルトでは、ゲストユーザーはディレクトリ情報の読み取り権限が制限されています。

---

## 2. Multi-Factor Authentication (MFA)

多要素認証 (MFA) は、ユーザー名とパスワードに加えて、さらに別の認証要素を要求することでセキュリティを強化する仕組みです。

### 2.1 認証の3要素
MFA は以下のうち2つ以上を組み合わせます。
1.  **知識情報 (Something you know)**: パスワード、PIN
2.  **所持情報 (Something you have)**: スマホ (Authenticator アプリ)、ハードウェアトークン、電話
3.  **生体情報 (Something you are)**: 指紋、顔認証

### 2.2 MFA の有効化方法（2つのパターン）
試験ではこの違いが重要です。

| 方法 | 説明 | 推奨度 |
| :--- | :--- | :--- |
| **ユーザーごとの MFA** (Legacy) | 特定のユーザーに対して常に MFA を強制する古典的な設定。Office 365 ポータルなどで設定。 | **非推奨** (柔軟性がないため) |
| **条件付きアクセス** (Modern) | 「社外からのアクセス時のみ MFA を要求する」など、状況に応じて制御する。これを使用するには **Azure AD Premium P1** ライセンスが必要。 | **推奨** |

### 2.3 MFA の設定項目
*   **不正アクセス警告 (Fraud Alert)**: ユーザーが身に覚えのない MFA 要求を受け取った際、「不正」として報告し、アカウントを自動でロックする機能。
*   **信頼済み IP (Trusted IPs)**: 社内ネットワーク（グローバルIP）からのアクセスの場合は MFA をスキップする設定。

---

## 3. 条件付きアクセス (Conditional Access)

「ゼロトラスト」モデルの中核となる機能です。
**「信号 (Signals)」** を判定し、条件を満たした場合に **「決定 (Decision)」** を下し、**「適用 (Enforcement)」** します。

これを使用するには **Azure AD Premium P1** 以上のライセンスが必要です。

### 3.1 構成要素 (If This, Then That)

図解イメージ:
`[誰が (User)] + [どこから (Location)] + [何を使って (Device)] -> [アプリ (App)] にアクセスする時 -> [アクション (MFA要求/ブロック)] を実行する`

#### 1. 割り当て (Assignments) = 条件 (Signals)
ポリシーを適用する対象を定義します。
*   **ユーザーとグループ**: 特定の管理者のみ、全員、ゲストのみ、など。
*   **クラウドアプリまたは操作**: Azure Portal, Office 365, または「すべてのアプリ」。
*   **条件 (Conditions)**:
    *   **ユーザーリスク**: 漏洩した資格情報の恐れがある場合 (要 **Azure AD Premium P2** / Identity Protection)。
    *   **サインインリスク**: 普段と違う場所からのアクセスなど (要 **P2**)。
    *   **デバイスプラットフォーム**: Windows, iOS, Android など。
    *   **場所 (Locations)**: 日本国内から、信頼済みIPから、など。
    *   **クライアントアプリ**: ブラウザ、モバイルアプリ、レガシー認証クライアント (POP/IMAP)。

#### 2. アクセス制御 (Access Controls) = 決定と適用
*   **許可 (Grant)**: アクセスを許可するが、条件を付ける。
    *   **多要素認証 (MFA) を要求する** (最も一般的)。
    *   **デバイスは準拠しているとしてマーク済みである必要がある** (Intune で管理され、ポリシーに適合している端末のみ許可)。
    *   **Hybrid Azure AD Join 済みデバイスが必要** (社内ドメイン参加端末のみ許可)。
*   **ブロック (Block)**: アクセスを拒否する。
    *   例: 海外からのアクセスはすべてブロック。

### 3.2 試験の頻出ポイント＆罠
> [!WARNING]
> **試験の罠：管理者ロックアウト**
> 条件付きアクセスで「すべてのユーザー」に対して「MFAを強制」し、さらに「MFA登録そのものができない状態」などに陥ると、管理者自身もサインインできなくなります。
> *   **対策**: 常に少なくとも1つの「緊急用アカウント (Break-glass account)」をポリシーの**除外設定 (Exclude)** に含める必要があります。
> *   このアカウントは通常、MFAを除外し、非常に複雑なパスワードを設定して厳重に監視します。

> [!TIP]
> **What If ツール**
> ポリシーを作成した後、実際にユーザーにどのような影響があるかをシミュレーションするツールです。
> 「あるユーザーが、ある条件でアクセスした場合、どのポリシーが適用されるか」を確認できます。

> [!NOTE]
> **レポート専用モード (Report-only mode)**
> ポリシーを実際に有効化（ユーザーに強制）する前に、ログに記録だけを行うモード。
> いきなり有効化して業務を止めてしまう事故を防ぐために使用します。

---

## 4. ロールベースのアクセス制御 (RBAC)

RBAC (Role-Based Access Control) は、「誰が」「どのリソースに対して」「何をしてよいか」をきめ細かく制御する仕組みです。

### 4.1 RBAC の3要素
1.  **セキュリティプリンシパル (Security Principal)**: 誰が (ユーザー、グループ、サービスプリンシパル、マネージド ID)。
2.  **ロール定義 (Role Definition)**: 権限のセット (読み取り、書き込み、削除など)。
3.  **スコープ (Scope)**: 適用範囲 (管理グループ > サブスクリプション > リソースグループ > リソース)。

### 4.2 スコープと継承
権限は親スコープから子スコープへ**継承**されます。
*   サブスクリプションで「所有者」権限を持つユーザーは、その配下のすべてのリソースグループ・リソースに対しても「所有者」となります。
*   下位スコープで権限を削除することはできません。

### 4.3 Azure AD ロール vs Azure RBAC ロール
**試験で最も間違えやすいポイントの筆頭です。**

| 特徴 | Azure AD ロール (Entra ID Roles) | Azure RBAC ロール (Azure Roles) |
| :--- | :--- | :--- |
| **管理対象** | Azure AD のオブジェクト (ユーザー、グループ、アプリ)、Office 365、Intune | Azure リソース (VM, Storage, SQL DB, Network など) |
| **管理ツール** | Azure Portal (Azure AD), M365 Admin Center | Azure Portal (Resource), PowerShell, CLI |
| **例** | グローバル管理者、ユーザー管理者、課金管理者 | 所有者、共同作成者、閲覧者 |
| **データアクセス** | ID情報へのアクセス | リソースの管理操作 (データそのものへのアクセス権を含む場合もある) |

> [!CAUTION]
> **重要: グローバル管理者の特権昇格**
> デフォルトでは「グローバル管理者」でも、Azure サブスクリプション（VMなど）へのアクセス権はありません。
> しかし、Azure AD のプロパティで **「Azure リソースのアクセス管理 (Access management for Azure resources)」** スイッチをオンにすると、自分自身に、テナント内の全サブスクリプションに対する **[ユーザーアクセス管理者]** ロールを割り当てることができます。
> これにより、すべての Azure リソースへのアクセス権を奪取（回復）できます。

### 4.4 一般的な組み込みロール (Built-in Roles)
Azure リソース向けの主要なロールです。

| ロール名 | 英語名 | 権限 | 試験のポイント |
| :--- | :--- | :--- | :--- |
| **所有者** | Owner | すべての操作 + **他者への権限割り当て** | 唯一、アクセス権の変更ができるロール。 |
| **共同作成者** | Contributor | すべての操作 (リソース作成・削除・変更) | **アクセス権の変更はできない**。 |
| **閲覧者** | Reader | 閲覧のみ | 設定変更不可。 |
| **ユーザーアクセス管理者** | User Access Administrator | **他者への権限割り当てのみ** | リソース自体の操作権限は持たない（設定変更などは不可）。 |

### 4.5 カスタムロール (Custom Roles)
組み込みロールで要件を満たせない場合、JSON 形式で独自のロールを作成できます。

`Actions`(許可する操作) と `NotActions`(許可から除外する操作) を組み合わせて定義します。
Azure RBAC は **「ホワイトリスト方式 (許可ベース)」** ですが、明示的な **Deny (拒否)** 設定 (Azure Blueprints / Management Group Deny Assignments) がある場合、**拒否が優先**されます。

#### JSON 定義の例
```json
"permissions": [
  {
    "actions": [
      "Microsoft.Compute/*/read",
      "Microsoft.Compute/virtualMachines/start/action",
      "Microsoft.Compute/virtualMachines/restart/action"
    ],
    "notActions": [
      "Microsoft.Compute/virtualMachines/write"
    ],
    "dataActions": [],
    "notDataActions": []
  }
]
```
*   ワイルドカード `*` を使用可能です。
*   `actions` に書かれた操作から `notActions` に書かれた操作を引き算したものが、最終的な許可権限になります。

---

## 5. Azure AD Connect とハイブリッド ID (Hybrid Identity)

オンプレミスの Active Directory 環境を Azure AD と統合するためのツールです。
「1つの ID」でオンプレとクラウドの両方のリソースにアクセスできるようにします。

### 5.1 同期と認証のオプション
Azure AD Connect のセットアップ時に最も重要な選択肢です。

| 認証方式 | 英語名 | 仕組み | 特徴 | 障害時の影響 |
| :--- | :--- | :--- | :--- | :--- |
| **パスワードハッシュ同期 (PHS)** | Password Hash Sync | パスワードのハッシュ値（のハッシュ）を Azure AD に同期コピーする。 | **最も簡単で推奨**。オンプレADが停止してもクラウド認証は可能。 | 影響なし (Azure ADだけで認証完結) |
| **パススルー認証 (PTA)** | Pass-through Authentication | ユーザーが入力したパスワードを、オンプレミスに設置した「エージェント」が受け取り、オンプレADで検証する。 | セキュリティポリシー（ログオン時間制限など）を即座に反映できる。パスワードはクラウドに保存されない。 | エージェント（オンプレ）が停止すると認証不可になる。 |
| **フェデレーション (AD FS)** | Federation with AD FS | 認証処理を完全にオンプレミスの AD FS サーバーに委任する。 | スマートカード認証や複雑なオンプレ要件がある場合に使用。構築が**最も複雑**。 | AD FS が停止すると認証不可。WAPサーバーなども必要。 |

> [!NOTE]
> **シームレス SSO (Seamless Single Sign-On)**
> PHS または PTA を選択した場合、オプションで有効化できます。
> 社内ネットワーク（ドメイン参加PC）からアクセスした際、パスワード入力を省略できます。
> (AD FS の場合は標準で SSO 機能を持っています)

### 5.2 パスワード書き戻し (Password Writeback)
Azure AD 側（SaaS アプリやセルフサービスパスワードリセット）で変更したパスワードを、オンプレミス AD に同期して戻す機能です。
*   これを使用するには **Azure AD Premium P1** 以上のライセンスが必要です。
*   同期の方向： 通常は「オンプレ -> Azure AD」の一方通行ですが、これを有効にすると双方向の一部機能が有効になります。

### 5.3 Azure AD Connect Health
オンプレミスの AD DS や AD FS サーバーの状態を Azure Portal から監視する機能です。
*   これを使用するには **Azure AD Premium P1** 以上のライセンスが必要です。
*   エージェントを各サーバーにインストールして使用します。

### 5.4 インストールと構成オプション
*   **簡単設定 (Express Settings)**:
    *   **パスワードハッシュ同期 (PHS)** が自動選択されます。
    *   SQL Server Express が自動インストールされます。
    *   スキーマ管理者 (Schema Admin) 権限などが一時的に必要です。
*   **カスタム設定 (Custom Settings)**:
    *   PTA や AD FS を選びたい場合。
    *   既存の SQL Server を使いたい場合。
    *   特定の OU (組織単位) のみを同期したい場合。

### 5.5 ステージングモード (Staging Mode)
Azure AD Connect サーバーの冗長化や移行テストに使用されるモードです。

*   **機能**: データを取り込みますが (Import)、**Azure AD への書き出し (Export) は行いません**。
*   **用途**:
    1.  **高可用性**: 2台目のサーバーをステージングモードで構築しておき、1台目が故障した際にステージングを解除して即座に昇格させる（アクティブ・パッシブ構成）。
    2.  **テスト**: 設定変更の影響を確認する。

> [!WARNING]
> **試験の罠：アクティブ・アクティブ構成は不可**
> 複数の Azure AD Connect サーバーで、同時に同じテナントへ書き込み (Export) を行うことは**サポートされていません**。
> 必ず「1台がアクティブ、他はステージングモード」にします。

---

---

## 6. 上級編: PowerShell/CLI とトラブルシューティング

AZ-104 試験では、GUI (ポータル) の操作だけでなく、PowerShell や Azure CLI コマンド、そしてトラブルシューティングの知識も問われます。

### 6.1 重要な PowerShell コマンドレット
ID管理において頻出のコマンドを比較します。
従来の **Azure AD PowerShell** (`AzureAD` モジュール) と、新しい **Microsoft Graph PowerShell** (`Mg` モジュール) がありますが、試験ではまだ `Az` モジュールや `AzureAD` モジュールが出題されることがあります。

| タスク | Azure AD Module (AzureAD) | Az Module / CLI | 備考 |
| :--- | :--- | :--- | :--- |
| **ユーザー作成** | `New-AzureADUser` | `az ad user create` | 必須パラメータに注意 (UserPrincipalName, DisplayName, PasswordProfile)。 |
| **グループ作成** | `New-AzureADGroup` | `az ad group create` | `-MailEnabled $false` `-SecurityEnabled $true` がセキュリティグループ。 |
| **ロール割り当て** | `New-AzureADDirectoryRoleAssignment` | `New-AzRoleAssignment` | **ここが重要**: `New-AzRoleAssignment` は **Azure RBAC** (リソース) 用。`New-AzureAD...` は **Azure AD ロール**用。 |

#### コマンド使用例: ユーザーの一括作成
CSV を読み込んでループ処理するシナリオは頻出です。

```powershell
# CSV フォーマット: Name, UPN, Department
$users = Import-Csv "C:\users.csv"
foreach ($user in $users) {
    New-AzureADUser -DisplayName $user.Name `
                    -UserPrincipalName $user.UPN `
                    -Department $user.Department `
                    -PasswordProfile $PasswordProfile
}
```

### 6.2 トラブルシューティング: Azure AD Connect
同期エラーに関する問題は、シナリオ形式でよく出題されます。

#### 1. 重複属性エラー (Duplicate Attributes)
*   **症状**: 同期サイクルが失敗し、「AttributeValueMustBeUnique」というエラーが出る。
*   **原因**: `UserPrincipalName` (UPN) や `ProxyAddresses` (SMTPメールアドレス) が、すでに Azure AD 上の別のユーザーで使用されている。
*   **対策**:
    1.  重複しているオブジェクトを特定する (IdFix ツールなどを使用)。
    2.  オンプレミス側の重複値を修正する。
    3.  同期を再実行する。

#### 2. ソフトマッチとハードマッチ
*   **ソフトマッチ (Soft Match)**: `UserPrincipalName` と `ProxyAddresses` が一致する場合、既存のクラウドユーザーとオンプレユーザーを紐づける。
*   **ハードマッチ (Hard Match)**: `sourceAnchor` (ImmutableID) を使用して、強制的に特定のユーザーと紐づける。「同期がうまくいかない」「別のユーザーとして作成されてしまう」場合の最終手段。

### 6.3 Privileged Identity Management (PIM)
**Azure AD Premium P2** が必須の機能です。
「必要な時に、必要な期間だけ」管理者権限を与える **JIT (Just-In-Time) アクセス** を実現します。

#### PIM のワークフロー
1.  **対象 (Eligible)**: ユーザーにロールを「資格あり」として割り当てます。（この時点では権限なし）
2.  **アクティブ化 (Activate)**: ユーザーが作業をする際、ポータルから「アクティブ化」を申請します。
    *   MFA が要求される場合がある。
    *   承認者の承認が必要な場合がある。
    *   利用理由の入力が必要。
3.  **期限付き権限**: 指定した時間（例: 2時間）だけ、管理者ロールが有効になります。その後、自動的に剥奪されます。

> [!TIP]
> **試験のポイント: PIM**
> *   「最小特権の原則」を実現する最適なソリューションとして解答になります。
> *   「常に管理者権限を持っている状態」のリスクを防ぐために導入します。
> *   監査ログ (Audit Log) により、誰がいつ権限を行使したか追跡可能です。

### 6.4 セルフサービスパスワードリセット (SSPR)
ユーザーが自分でパスワードをリセットできるようにする機能です。ヘルプデスクの負荷を軽減します。

*   **要件**: Azure AD P1 以上 (クラウド専用ユーザーのみなら Free でも一部可だが、書き戻しは P1)。
*   **認証方法**: リセット時に「2つ」の情報を求めるのが一般的。
    *   モバイルアプリ通知
    *   SMS コード
    *   メール (代替アドレス)
    *   秘密の質問
*   **管理者ポリシー**: 管理者はデフォルトで SSPR が有効になっています（強力な認証が必要）。これを無効にすることはできません。

---

---

## 7. まとめと試験への心構え

### ID・アクセス管理の重要ポイント一覧
1.  **テナントとサブスクリプション**: 1対多の関係性、信頼の方向。
2.  **Azure AD ロール vs Azure RBAC**: 管理対象の違い（ID vs リソース）。
3.  **MFA**: 「条件付きアクセス」による制御がモダンで推奨される。
4.  **条件付きアクセス**: 緊急用アカウントの除外を忘れない。
5.  **ハイブリッド ID**: PHS が基本、要件に応じて PTA/Federation。ステージングモードの役割。

### 最後に
AZ-104 において、ID・アクセス管理は **20-25%** のウェイトを占める非常に重要なセクションです。
特に **「誰が(Principal)」「どこで(Scope)」「何を(Role)」「どういう条件で(Conditional Access)」** できるのか、という視点で問題を読み解くことが合格への近道です。

このガイドが学習の一助となり、試験合格につながることを心より願っています。
**Good Luck!**

 
 

# 監視・管理 (Monitor & Management)

本セクションでは、Azureの監視と管理に関するサービスを解説します。
AZ-104試験では、**「何を監視するか」「データはどこに保存されるか」「どのように通知するか」** という点が重要になります。

---

## 1. Azure Monitor (監視の要)

**Azure Monitor** は、Azure上のあらゆるリソース（VM、アプリ、ネットワークなど）や、オンプレミスのリソースからデータを収集し、分析・視覚化・対応を行うための統合監視ソリューションです。

### 1.1 データの種類：メトリックとログ (重要!)

Azure Monitorが収集するデータは、大きく **「メトリック (Metrics)」** と **「ログ (Logs)」** の2種類に分類されます。この違いは試験で頻出です。

| 特徴 | メトリック (Metrics) | ログ (Logs) |
| :--- | :--- | :--- |
| **データ形式** | **数値データ** (例: CPU使用率 80%、メモリ空き容量 2GB) | **レコード/テキストデータ** (例: エラーメッセージ、イベントログ) |
| **特徴** | **軽量** で **リアルタイム** 性が高い。 | 詳細な情報を含み、複雑な **クエリ分析** が可能。 |
| **用途** | アラート検知、自動スケーリング (Autoscale)、ダッシュボード表示 | 根本原因分析、詳細なトラブルシューティング、セキュリティ監査 |
| **保存先** | Azure Monitor Metrics データベース (時系列DB) | **Log Analytics ワークスペース** |

> [!IMPORTANT]
> **試験対策ポイント**:
> - 「CPU使用率が90%を超えたら通知したい」→ **メトリック** のアラート。
> - 「過去1週間の特定のエラーログを検索したい」→ **ログ** (Log Analytics)。
> - 「過去の傾向を分析したい」→ **ログ** (Log Analytics)。
> - 「即座に反応してオートスケールさせたい」→ **メトリック**。

### 1.2 アラート (Alerts)

異常を検知した際に通知やアクションを行う機能です。3つのコンポーネントで構成されます。

1.  **ターゲット (Target)**: 監視対象のリソース (例: 特定のVM)。
2.  **シグナル (Signal)**: 判断基準となるデータ (例: メトリック、ログクエリ、アクティビティログ)。
3.  **ロジック (Logic)**: 条件 (例: 5分間の平均CPU使用率 > 80%)。
4.  **アクション (Action)**: 条件を満たしたときの動作。**アクションリングループ (Action Group)** で定義します。

> [!NOTE]
> **アクショングループ (Action Group)** で設定できること:
> - **通知**: メール (Email)、SMS、プッシュ通知、音声通話。
> - **自動化**: Azure Functions、Logic Apps、Automation Runbook、Webhook の実行。
> - **ITSM連携**: ServiceNowなどのチケット管理システムへの連携。

---

## 2. Log Analytics (ログ分析の基盤)

**Log Analytics** は、Azure Monitor Logs のデータを保存・分析するためのツールです。
ログデータの格納庫を **「Log Analytics ワークスペース (Workspace)」** と呼びます。

### 2.1 Kusto Query Language (KQL)

ログを検索・分析するために使用するクエリ言語です。SQLに似ていますが、データ処理のパイプライン（`|` でつなぐ）形式で記述します。

*   **試験レベルの知識**: 複雑なクエリを書ける必要はありませんが、「KQLを使ってログを検索する」という事実は知っておく必要があります。

### 2.2 エージェント (Agents)

VMなどからログを収集するためにエージェントが必要です。
現在は **Azure Monitor Agent (AMA)** への移行が進んでいますが、試験では旧来の **Log Analytics Agent (MMA/OMS Agent)** も登場する可能性があります。

> [!WARNING]
> **試験対策ポイント**:
> - **Azure Monitor Agent (AMA)**: 最新のエージェント。**データ収集ルール (DCR: Data Collection Rules)** を使用して、「どのログを収集するか」「どこに送るか」を細かく制御できるのが最大の特徴です。
> - **Log Analytics Agent (MMA)**: 旧エージェント。ワークスペース単位で設定するため、細かい制御が苦手でした。

### 2.3 接続ソース

Log Analytics ワークスペースには、以下のような多様なソースからログを集約できます。
- Azure 仮想マシン (VM)
- オンプレミスのサーバー (Windows/Linux)
- Azure Storage (診断ログ)
- Azure Activity Log (アクティビティログ)

---

## 3. Application Insights (アプリの監視)

**Application Insights** は、開発者向けの **APM (Application Performance Management)** サービスです。
主に 「Webアプリケーション」 のパフォーマンスや動作を監視します。

### 3.1 監視できること

- **リクエスト数**: アプリへのアクセス頻度。
- **応答時間**: ページの読み込みにかかる時間。
- **失敗率 (Failure Rate)**: エラーの発生頻度。
- **例外 (Exceptions)**: コードレベルでのクラッシュ情報。
- **ページビュー**: ユーザーのブラウザ側での読み込みパフォーマンス。
- **依存関係 (Dependencies)**: SQLデータベースや外部API呼び出しの応答時間や成功率。

### 3.2 可用性テスト (Availability Tests)

世界中の複数の場所から、定期的にWebアプリにアクセスし、稼働しているかを確認する機能です。「Pingテスト」や「URL Ping テスト」とも呼ばれます。

> [!TIP]
> **試験のひっかけ**:
> - 「仮想マシンのCPU監視」は **Azure Monitor (Metrics)**。
> - 「Webアプリのページ読み込み速度が遅い原因の特定」は **Application Insights**。
> - 「Webサイトが世界中からアクセス可能かチェックしたい」は **Application Insights の可用性テスト**。

### 3.3 スマート検出 (Smart Detection)

機械学習を使用して、異常なパターン（例: エラー率の突然の上昇、ページの読み込み遅延）を自動的に検出し、通知してくれる機能です。設定不要で利用できるものもあります。

---

## カンニングペーパー：監視サービスの使い分け

試験で迷ったときは、この表を思い出してください，

| シナリオ | 推奨サービス |
| :--- | :--- |
| **OSレベル** の情報 (CPU, メモリ, ディスク) を見たい | **Azure Monitor** (Metrics / Logs) |
| **コードレベル** の情報 (例外, 処理時間, SQLクエリ) を見たい | **Application Insights** |
| 複数のリソースのログを **一元管理・分析** したい | **Log Analytics** |
| アラート発報時に **自動修復** したい | Azure Monitor Alert + **Action Group (Automation/Logic App)** |
| 誰がいつリソースを作成・削除したか知りたい | **Activity Log (アクティビティログ)** |

# 推奨事項とヘルスの監視 (Recommendations & Health)

このセクションでは、Azure環境をより良くするためのアドバイスや、Azure自体の障害情報をどう受け取るかについて解説します。
両者は混同しやすいので、明確に違いを理解しましょう。

---

## 4. Azure Advisor (あなた専用のクラウドコンサルタント)

**Azure Advisor** は、あなたのAzure環境の設定を分析し、Microsoftのベストプラクティスに基づいた **「推奨事項 (Recommendations)」** を提示してくれる無料サービスです。

### 4.1 Well-Architected Framework の5つの柱

Advisorの推奨事項は、以下の5つのカテゴリに分類されます。これは試験で頻出です。

1.  **信頼性 (Reliability)**: システムの稼働時間を向上させる。（例: VMのバックアップを有効にする、可用性ゾーンを使用する）
2.  **セキュリティ (Security)**: 脅威から保護する。（例: MFAを有効にする、NSGでポートを閉じる）
    *   ※内部的に **Microsoft Defender for Cloud** と統合されています。
3.  **パフォーマンス (Performance)**: アプリケーションの速度を向上させる。（例: Web AppsのSKUをスケールアップする）
4.  **コスト (Cost)**: 無駄な出費を減らす。（例: 使用されていないVMをシャットダウンする、予約インスタンスを購入する）
5.  **オペレーショナル エクセレンス (Operational Excellence)**: 運用効率を上げる。（例: Service Healthアラートを作成する）

### 4.2 スコア (Advisor Score)

環境の健全性を 0% 〜 100% のスコアで可視化します。スコアが低いほど、改善の余地（リスク）があることを示します。

> [!IMPORTANT]
> **試験対策ポイント**:
> - 「Azureの利用料金を削減したい、何か良い案はないか？」と聞かれたら → **Azure Advisor** の「コスト」推奨事項を確認する。
> - 「セキュリティの脆弱性を見つけて修正したい」 → **Azure Advisor** (または Defender for Cloud)。
> - **Advisorは「設定の変更」を提案するだけで、自動的に直してくれるわけではありません**（一部の「クイック修正」を除く）。

---

## 5. Azure Service Health (Azureの健康診断)

**Azure Service Health** は、Azureのデータセンターやサービス自体に発生している問題が、**「あなたのリソースにどう影響するか」** を教えてくれるサービスです。

### 5.1 3つのイベントタイプ

Service Healthが通知するイベントは以下の3種類です。

| イベントタイプ | 説明 | 例 |
| :--- | :--- | :--- |
| **サービスの問題 (Service Issues)** | Azure側で発生している障害。 | 「東日本リージョンでStorageがダウンしています」 |
| **計画メンテナンス (Planned Maintenance)** | 予定されているメンテナンス作業。 | 「来週の月曜日にVMの再起動を伴うメンテナンスがあります」 |
| **正常性の勧告 (Health Advisories)** | 対応が必要な変更や非推奨の情報。 | 「古いAPIが廃止されるため、更新してください」 |

### 5.2 パーソナライズされたダッシュボード

Azure全体の障害情報（status.azure.com）とは異なり、Service Healthは **「あなたが使用しているサブスクリプション、リージョン、サービス」** に関連する情報だけを表示します。これが最大の特徴です。

### 5.3 Service Health アラート

障害が発生したときにすぐに知るために、**アラート** を設定できます。
これは Azure Monitor のアラート機能の一部として動作し、メールやSMSで通知を受け取れます。

> [!TIP]
> **試験のひっかけ**:
> - 「世界中のAzureの障害状況を一般公開されているページで見たい」→ **Azure Status** (status.azure.com)。
> - 「**自分の** VMに影響する障害情報をメールで受け取りたい」→ **Azure Service Health**。
> - 「将来行われるメンテナンス計画を知りたい」→ **Azure Service Health** (計画メンテナンス)。

---

## カンニングペーパー：Advisor vs Service Health

| 特徴 | Azure Advisor | Azure Service Health |
| :--- | :--- | :--- |
| **目的** | 環境の **最適化** (ベストプラクティス) | Azureサービス自体の **障害・メンテナンス情報** |
| **内容** | 「こう設定を変えたほうがいいですよ」 | 「今Azure側でトラブルが起きていますよ」 |
| **アクション** | ユーザーが設定を変更する | ユーザーは復旧を待つか、DR対策を発動する |
| **キーワード** | コスト削減、セキュリティ向上、パフォーマンス改善 | 障害 (Outage)、メンテナンス、ダウンタイム |

# アーキテクチャとIaC (Architecture & IaC)

このセクションでは、Azureのリソース管理の基本となる構造と、コードによるインフラ管理 (Infrastructure as Code) について解説します。

---

## 6. Azure Resource Manager (ARM)

**Azure Resource Manager (ARM)** は、Azureの「管理レイヤー」です。
Portal、CLI、PowerShellなど、あらゆる手段で行われる操作は、最終的にすべてARM APIを通じて処理されます。これにより、どのツールを使っても一貫したアクセス制御 (RBAC)、タグ付け、ログ記録が適用されます。

### 6.1 リソース階層 (Hierarchy)

Azureのリソースは以下の親子関係で管理されます。

1.  **管理グループ (Management Groups)**: 最上位。複数のサブスクリプションをまとめてポリシーを適用するために使用します。（例: 全社のコンプライアンス適用）
2.  **サブスクリプション (Subscriptions)**: 課金と契約の単位。
3.  **リソースグループ (Resource Groups)**: ライフサイクルが同じリソースをまとめる論理的なコンテナ。**すべてのリソースは必ず1つのリソースグループに属する必要があります。**
4.  **リソース (Resources)**: VM、ストレージ、DBなどの実体。

> [!IMPORTANT]
> **試験対策ポイント (リソースグループ)**:
> - リソースグループを削除すると、**中にあるすべてのリソースも削除されます**。
> - リソースは作成後に別のリソースグループに**移動 (Move)** できます（一部の制限を除く）。
> - リソースグループには場所（リージョン）を指定しますが、**リソース自体は別のリージョンにあっても構いません**。

### 6.2 リソースロック (Resource Locks)

誤操作による変更や削除を防ぐ機能です。管理者 (Owner) であっても、ロックを解除しない限り操作できません。

| ロックの種類 | 英語名 | 説明 |
| :--- | :--- | :--- |
| **削除 (CanNotDelete)** | Delete | 読み取りと変更は可能だが、**削除はできない**。 |
| **読み取り専用 (ReadOnly)** | Read-only | **読み取りのみ** 可能。変更も削除もできない。 |

> [!WARNING]
> **継承 (Inheritance) のルール**:
> - 親スコープ（例: リソースグループ）にロックをかけると、**すべての子リソースに継承されます**。
> - 最も厳しいロックが優先されます。（例: 親がReadOnlyなら、子は変更不可）
> - **重要**: ReadOnlyロックをかけると、**一部の操作ができなくなる** 場合があります。例として、Storage Accountのアクセスキーの表示や、App Serviceの再起動などがこれに該当します（これらは内部的に「書き込み」操作が必要なため）。

### 6.3 タグ (Tags)

リソースに `Key: Value` のペア（例: `Department: IT`, `Environment: Production`）を付与して分類する機能です。
**課金レポートでのコスト分析** に最もよく使われます。
※タグはリソースロックと異なり、子リソースには **継承されません**（継承させるにはPolicyなどが必要です）。

---

## 7. ARM テンプレート (IaCの基本)

**ARM テンプレート** は、Azureのリソース構成を **JSON形式** のコードで定義したファイルです。
これにより、同じ環境を何度でも正確に再現できます（**冪等性**: Idempotency）。

### 7.1 JSONファイルの基本構造

試験では、JSONファイルの構造穴埋め問題が出ることがあります。主要なセクションを覚えましょう。

```json
{
  "$schema": "https://schema.management.azure.com/...",
  "contentVersion": "1.0.0.0",
  "parameters": { ... },    // 実行時に入力する値 (例: VMの名前)
  "variables": { ... },     // 内部で使用する変数 (例: リソース名のプレフィックス)
  "functions": { ... },     // ユーザー定義関数 (高度な利用)
  "resources": [ ... ],     // **最重要**: 作成するリソースの定義
  "outputs": { ... }        // 実行後に出力する値 (例: 作成されたVMのIPアドレス)
}
```

### 7.2 parameters と variables の違い

- **parameters**: **デプロイする人** が決める値。（ユーザー名、パスワード、VMサイズなど、環境ごとに変えたいもの）
- **variables**: **テンプレート作成者** が決める値。（固定の命名規則、計算された値など、ユーザーに入力させたくないもの）

### 7.3 デプロイモード

- **増分 (Incremental)**: デフォルト。既存のリソースはそのままに、新しいリソースを追加または更新します。
- **完全 (Complete)**: テンプレートに記述されていないリソースは **削除** されます。環境をテンプレートと完全に一致させたい場合に使用します。

---

## カンニングペーパー：リソース管理

| 機能 | 目的 |
| :--- | :--- |
| **リソースグループ** | ライフサイクル管理（まとめて削除など）。リージョンはリソースと異なってもOK。 |
| **リソースロック** | 誤削除・誤変更の防止。**継承される**。 |
| **タグ** | コスト管理・整理。**継承されない**。 |
| **ARM テンプレート** | IaC (コードによるインフラ管理)。JSON形式。**冪等性** がある。 |

# 管理ツール (Management Tools)

Azureを操作するためのツールはいくつかあります。試験では、**「どのツールを使ってどう操作するか」**、特に **CLI と PowerShell のコマンドの違い** が問われます。

---

## 8. Azure Portal

Webブラウザから操作するGUIツールです。初心者には最も優しいですが、大量のリソースを扱う場合や自動化には向きません。
すべての操作はバックグラウンドでARM APIを呼び出しています。

---

## 9. Azure Cloud Shell

ブラウザ内で直接実行できる、管理用のシェル環境です。
**PowerShell** または **Bash (Azure CLI)** のどちらかを選択して起動できます。

> [!IMPORTANT]
> **試験対策ポイント**:
> - Cloud Shellを初めて起動するとき、**ストレージアカウント (Azure Storage)** が必要です（ファイルを永続化するため）。
> - PCに何もインストールしなくても、ブラウザだけでコマンド操作が可能です。
> - `clouddrive` ディレクトリに保存したファイルだけが永続化されます。

---

## 10. Azure CLI vs Azure PowerShell

試験では、提示されたコマンドを見て「これは CLI か PowerShell か？」を判断したり、穴埋めをする問題が出ます。

### 10.1 Azure CLI (Command-Line Interface)

- **構文**: `az <group> <subgroup> <command>`
- **特徴**: Pythonベースで、Linux/Mac/Windowsで動作するクロスプラットフォームツール。
- **データ形式**: JSON での出力が標準。

**例: VMの作成**
```bash
az vm create --resource-group MyRG --name MyVM --image UbuntuLTS ...
```

### 10.2 Azure PowerShell

- **構文**: `Verb-Noun` (動詞-名詞) の形式。
- **特徴**: .NETベース。オブジェクト指向で、オブジェクトをパイプラインで渡せます。
- **モジュール**: `Az` モジュールを使用します（古い `AzureRM` は非推奨）。

**例: VMの作成**
```powershell
New-AzVM -ResourceGroupName "MyRG" -Name "MyVM" -Image "UbuntuLTS" ...
```

### 10.3 見分け方のコツ (超重要)

| ツール | コマンドの始まり | パラメータの指定 | フィルタリング方法 |
| :--- | :--- | :--- | :--- |
| **Azure CLI** | `az ...` で始まる | `--name` や `-n` (ハイフン) | `--query` (JMESPathを使用) |
| **PowerShell** | `Get-Az...`, `New-Az...` | `-Name` (ハイフン) | `Where-Object` などをパイプ `|` で繋ぐ |

> [!TIP]
> **試験のひっかけ**:
> - 「スクリプトを書いて自動化したい。Linux管理者にも馴染みがあるツールが良い」→ **Azure CLI** (Bashライクなため)。
> - 「Windows環境で、既存のPowerShell資産を活かしたい」→ **Azure PowerShell**。
> - コマンドオプションに `--query` があったら **Azure CLI**。

---

## 11. まとめ：ツールの使い分け

| シナリオ | 推奨ツール |
| :--- | :--- |
| 初めてAzureを触る、視覚的に操作したい | **Azure Portal** |
| 手元のPCに環境構築せず、すぐコマンドを実行したい | **Azure Cloud Shell** |
| Linux/Mac ユーザー、または JSON に慣れている | **Azure CLI** |
| Windows ユーザー、または オブジェクト操作に慣れている | **Azure PowerShell** |
| 同じ構成の環境を何度も自動デプロイしたい | **ARM テンプレート (Bicep)** |

 
 
# AZ-104 完全攻略ガイド：バックアップ・復旧・ガバナンス編

## はじめに：このガイドの使い方と合格へのマインドセット

Azure Administrator Associate (AZ-104) の学習をこれから始める方、あるいは学習中の方へ。
このガイドは、公式ドキュメントのような無味乾燥な技術仕様書ではありません。**「現場でどう使うか？」「試験ではどこで引っ掛けられるか？」** という視点を徹底的に重視し、まるで先輩エンジニアが隣で優しく（時には厳しく）教えてくれるようなテキストを目指しました。

### 対象読者
- Azure 初学者～中級者
- AZ-104 試験合格を目指す方
- 「機能は知っているけど、実際の使い分けが曖昧」という方

### AZ-104 合格の鍵：3つの「意識」
試験勉強を進める上で、常に頭の片隅に置いてほしい3つのキーワードがあります。これはそのまま、試験の正答率に直結します。

1.  **最小特権の原則 (Least Privilege)**
    *   「管理者は何でもできる」はNGです。必要な人に、必要な権限だけを与える。これがAzureの鉄則です。
    *   例：「仮想マシンの再起動だけさせたい人」に「所有者(Owner)」権限を与えてはいけません。「仮想マシンコントリビューター」でも強すぎるかもしれません。

2.  **コスト最適化 (Cost Optimization)**
    *   クラウドは従量課金です。無駄なリソースは1秒でも早く消す、あるいは安いプランを使う。
    *   例：「長期間ログを保存したいが、滅多に見ない」→ ホット層ではなく、アーカイブ層を使うのが正解。

3.  **高可用性と災害復旧 (BCDR)**
    *   「サーバーは壊れるもの」という前提で設計します。
    *   リージョン（地域）が丸ごとダウンしても、ビジネスを止めないためにはどうすればいいか？これを常に問われます。

---

## 第1章：バックアップと復旧 (Backup & Recovery)

システム運用において最も地味ですが、最も重要なのが「バックアップ」です。データが消えたとき、最後の砦となるのがこの機能です。Azureには大きく分けて **Azure Backup** と **Azure Site Recovery (ASR)** の2つがあります。

> [!IMPORTANT]
> **試験での超重要ポイント：Backup と Site Recovery の違い**
> *   **Azure Backup**: 「データのコピー」を取るもの。データが消えたら、過去の時点に戻す。 (目的：**データの保全**)
> *   **Azure Site Recovery**: 「システムの複製」を別の場所に用意しておくもの。本番が止まったら、予備に切り替える。 (目的：**ビジネスの継続**)
> *   試験で「ランサムウェア対策」「誤削除からの復旧」と来たら **Backup**。
> *   試験で「リージョン障害時の即時復旧」「災害対策」と来たら **Site Recovery**。

---

### 1-1. Azure Backup

Azure Backup は、オンプレミスのサーバーや、Azure上の仮想マシン(VM)、SQL Database などのデータを安全に保護するサービスです。

#### 1-1-1. Recovery Services コンテナー (Recovery Services Vault)
すべてのバックアップの基本となる「金庫」です。バックアップデータはこの中に保存されます。

-   **作成時の注意点**: バックアップ対象のリソース（例えばVM）と **同じリージョン** に作成する必要があります。
    *   *引っ掛けポイント*: 「VMは東日本リージョンにあるが、バックアップは西日本リージョンに直接取りたい」→ **できません**。まずは同じリージョンのVaultにバックアップし、Vaultの機能で「ジオ冗長(GRS)」を使って別リージョンにコピーされる仕組みです。

#### 1-1-2. バックアップポリシー
「いつバックアップを取るか？」「いつまで保存するか？」を決めるルールです。

-   **頻度 (Frequency)**: 毎日 (Daily) または 毎週 (Weekly)。
    *   *注意*: Azure VMバックアップは **1日1回** が基本です。（拡張機能を使えば頻度を上げられますが、標準では日次です。）
-   **保持期間 (Retention)**: 日次、週次、月次、年次で設定可能。
    *   例：日次は30日、月次は12ヶ月、年次は10年残す、といった設定（**GFS: Grandfather-Father-Son** 方式）が可能です。

#### 1-1-3. オンプレミスのバックアップ (MARS エージェント vs MABS)
ここが非常にややこしく、試験でも頻出です。オンプレミスのサーバーをAzureにバックアップする場合、主に2つの方法があります。

| 機能 | MARS エージェント (Microsoft Azure Recovery Services) | MABS (Microsoft Azure Backup Server) |
| :--- | :--- | :--- |
| **別名** | Azure Backup エージェント | (実体は System Center DPM の軽量版) |
| **インストール場所** | バックアップしたい各サーバーに直接インストール | 仲介役となる専用サーバーを1台立てる |
| **バックアップ対象** | **ファイル、フォルダー、システム状態** のみ | **アプリケーション (SQL, Exchange, SharePoint)**、VMイメージ、ベアメタル |
| **Linux対応** | **× (Windowsのみ)** | 〇 (間接的に可能) |
| **管理コンソール** | 各サーバーの画面で管理 | MABSサーバーで一元管理 |

> [!WARNING]
> **試験の鉄板引っ掛け問題**
> *   「オンプレミスの **SQL Server** のデータベースをAzureにバックアップしたい。MARSエージェントで実施する。」
>     *   → **× 間違い** です。MARSエージェントは「ファイルレベル」しか分かりません。SQLのようなアプリ整合性が必要なものは **MABS** (またはAzure Backup Server) が必要です。
> *   「システム全体（ベアメタル）を復旧したい。」
>     *   → これも **MABS** です。MARSはファイル単位だからです。

#### 1-1-4. Azure VM のバックアップ
Azure 上の仮想マシンのバックアップは非常に簡単です。エージェント不要（実際はVM Extensionsが自動で入ります）で、ポータルから数クリックで設定できます。

-   **スナップショットとバックアップの違い**
    *   バックアップ処理が走ると、まず **スナップショット** が作成されます（これが速い）。
    *   その後、スナップショットデータが **Vault（コンテナー）** に転送されます（これには時間がかかる）。
    *   **インスタントリストア (Instant Restore)**: Vaultに転送されるのを待たず、作成されたスナップショットから即座にVMを復旧する機能。通常1～5日間保持されます。

-   **整合性レベル (Consistency Level)**
    1.  **アプリケーション整合性 (Application Consistent)**:
        *   メモリ内のデータやI/Oもフラッシュしてから取る。復旧時にアプリが正常に起動する。Windows VMのデフォルト（VSSを使用）。
    2.  **ファイルシステム整合性 (File System Consistent)**:
        *   ファイルは壊れていないが、アプリの状態までは保証しない。Linux VMのデフォルト。
    3.  **クラッシュ整合性 (Crash Consistent)**:
        *   電源をブチっと切った状態と同じ。VMが起動していない時にバックアップを取るとこうなる。

#### 1-1-5. 復旧 (Restore) の種類
データを戻すときにもいくつか選択肢があります。

1.  **ファイルリカバリ (File Recovery)**:
    *   VM全体ではなく、「あのExcelファイル1つだけ戻したい」という場合。
    *   **重要**: 実はこれ、ブラウザからポチっとダウンロードできるわけではありません。専用のスクリプト(EXE)が生成され、それをPCで実行すると、バックアップデータが **「ドライブ」としてマウント** されます。そこからコピペで救出します。
2.  **VMの復元 (Create New VM)**:
    *   バックアップから新しいVMを作ります。
3.  **ディスクの復元 (Restore Disks)**:
    *   VMは作らず、VHDファイル（ディスク）だけを取り出します。既存のVMに付け替えたり、調査したりする場合に使います。
4.  **既存の置換 (Replace Existing)**:
    *   今のVMのディスクを、バックアップ時点のものに入れ替えます。

#### 1-1-6. バックアップデータの保護 (Soft Delete)
ランサムウェアや悪意ある管理者が「バックアップを全消去」してしまったら終わりでしょうか？
いいえ、Azure Backup には **ソフトデリート (Soft Delete)** 機能があります。

*   バックアップデータを削除しても、**14日間** は「ゴミ箱」のような状態で保持されます。
*   この期間内なら、削除を取り消してデータを復活できます。
*   **デフォルトで有効** です。

---

### 1-2. Azure Site Recovery (ASR)

BCDR (Business Continuity and Disaster Recovery) の要です。
「東日本リージョンで大地震が起きてデータセンターが潰れた。すぐに西日本リージョンでシステムを再開させたい。」
こういうシナリオで使います。

#### 1-2-1. 仕組み
1.  **レプリケーション**: プライマリ（稼働中）サイトのVMの書き込みを、セカンダリ（待機系）サイトに常にコピーし続けます。
2.  **フェイルオーバー**: 災害発生時、セカンダリサイトでVMを起動し、処理を引き継ぎます。
3.  **フェイルバック**: プライマリが復旧したら、差分データを書き戻して元の場所に戻ります。

#### 1-2-2. 重要用語：RPO と RTO
*   **RPO (Recovery Point Objective / 目標復旧時点)**:
    *   「どの時点までデータを戻せるか？」「最大どれくらいのデータを失う可能性があるか？」
    *   Azure VM間レプリケーションの場合、RPOは最短で数秒～数分です。
*   **RTO (Recovery Time Objective / 目標復旧時間)**:
    *   「システム復旧までにどれくらい時間がかかるか？」
    *   SLAでは2時間以内などが設定されます。

#### 1-2-3. フェイルオーバーの種類 (試験頻出！)
試験では「今どのフェイルオーバーを行うべきか？」が問われます。

1.  **テストフェイルオーバー (Test Failover)**:
    *   **目的**: 避難訓練。本当に復旧できるか確認する。
    *   **特徴**: 本番環境（レプリケーション）には **一切影響を与えません**。
    *   **仕組み**: テスト用の独立したネットワークに、コピーVMを作成します。
    *   *試験対策*: 「BCDRのテストを行いたいが、本番稼働中のアプリを止めたくない」→ **テストフェイルオーバー** 一択です。

2.  **計画的なフェイルオーバー (Planned Failover)**:
    *   **目的**: 計画停電やメンテナンスによるサイト切り替え。
    *   **特徴**: **データ損失ゼロ** を目指します。プライマリシャットダウン → 未転送データを同期 → セカンダリ起動、という手順を丁寧に行います。

3.  **フェイルオーバー (Unplanned Failover)**:
    *   **目的**: 本当の災害時。プライマリが死んでいるので、いきなりセカンダリを立ち上げます。
    *   **特徴**: 直前のデータが一部同期されていない可能性があります（RPO依存）。

#### 1-2-4. 一貫性のない設定ミスあるある
Site Recovery をただ有効にしただけでは、災害時にシステムは動きません。なぜなら…
*   **ネットワーク** はレプリケートされません。セカンダリ側の VNet、サブネット、IPアドレス設定を手動でマッピングしておく必要があります。
*   **依存関係**。Webサーバーだけ起き上がっても、DBサーバーが寝ていたら動きません。「復旧計画 (Recovery Plans)」という機能を使って、「まずDBを起動、3分待ってWebを起動」といった順序を定義します。

---

## 第2章：ガバナンスとコンプライアンス (Governance & Compliance)

クラウドは誰でも簡単にリソースを作れるからこそ、「散らかる」「危険な設定がされる」というリスクがあります。これを統制するのがガバナンス機能です。

### 2-1. Resource Groups (リソースグループ)
Azure のリソースをまとめる論理的な「箱」です。「リソースは必ず1つのリソースグループに属する」というルールがあります。

#### 2-1-1. リソースロック (Resource Locks)
管理者が手動で設定する「誤操作防止」機能です。サブスクリプション、リソースグループ、リソース個別に設定できます。

1.  **Read Only (読み取り専用)**:
    *   **変更も削除もできません**。
    *   *落とし穴*: 「えっ、読み取りだけ？」と思うかもしれませんが、一部の「読み取りに見える操作」もブロックされます。例えば **ストレージアカウントのアクセスキーの表示 (List Keys)** は、裏側でPOSTリクエストを投げるため「変更」とみなされ、ブロックされます。
2.  **Can Not Delete (削除不可)**:
    *   **削除はできません** が、**変更 (設定変更、再起動など) は可能** です。
    *   *試験対策*: 「本番環境のVMを誤って削除しないようにしたいが、管理作業（再起動やサイズ変更）は行いたい」→ **Can Not Delete** が正解。

3.  **継承 (Inheritance)**:
    *   親（リソースグループ）にロックをかけると、子（VMなど）にも継承されます。
    *   **子が親のロックを無効化することはできません**。

#### 2-1-2. リソースの移動 (Move Resources)
作成後にリソースグループやサブスクリプションをまたいでリソースを移動することができます。
ただし、いくつかの制約があります。
*   **移動中はロックがかかる**: 移動操作中はリソースがロックされ、変更できません（稼働は継続します）。
*   **依存関係**: VMを移動するときは、関連するディスクやNICも一緒に移動するのがベストプラクティスです。

---

### 2-2. Azure Policy

「開発者が勝手なことをしないように、自動で見張るガードマン」です。
**JSON** 形式でルールを定義します。

#### 2-2-1. Policy と RBAC の違い (超重要)
*   **RBAC (Role-Based Access Control)**:
    *   「**誰が (Who)**」操作できるかを制御する。
    *   例：「AさんはVMを作成できる」
*   **Azure Policy**:
    *   「**どんな (What)**」リソースが作成できるかを制御する。誰がやるかは関係ありません。
    *   例：「誰であっても、"Fシリーズ" などの高価なVMは作成禁止」「すべてのリソースに "Environment" タグを必須にする」

#### 2-2-2. 効果 (Effects)
ポリシー違反があった場合、どう振る舞うかを設定します。
1.  **Deny**: 作成・変更を **ブロック** します。エラーが出て操作が失敗します。
2.  **Audit**: 作成は許可するが、**警告ログ** を残します。「非準拠 (Non-compliant)」としてマークされます。
3.  **Append / Modify**: 足りない設定を **自動で追加・修正** します。（例：タグが無いなら自動で付与する）
4.  **DeployIfNotExists**: 必要なリソースが無ければ **デプロイ** します。（例：VMを作ったら、自動で監視エージェントもインストールする）

#### 2-2-3. イニシアティブ (Initiative)
複数のポリシーをまとめたセットのことです。「ポリシーセット定義」とも呼ばれます。
数百個のポリシーを1つ1つ割り当てるのは大変なので、イニシアティブとしてまとめて割り当てます。

---

### 2-3. Azure Blueprints

「環境構築の設計図」です。新しいサブスクリプションを払い出したとき、すぐに「標準準拠の状態」にするために使います。

#### 2-3-1. 含まれるもの (アーティファクト)
Blueprint は以下の4つをパッケージ化できます。
1.  **リソースグループ**
2.  **ARM テンプレート** (リソースの配備)
3.  **Policy** の割り当て
4.  **RBAC (ロール割り当て)**

#### 2-3-2. ブループリントのロック (Blueprint Locks)
ここが試験のハイライトです。Blueprint でデプロイしたリソースを保護するための特別なロック機能があります。
*   **Don't Lock**: ロックなし。
*   **Do Not Delete**: 削除不可。
*   **Read Only**: 変更・削除不可。

> [!NOTE]
> **Resource Locks との違いは？**
> Blueprint のロックは、**所有者 (Owner) 権限を持つユーザーであっても解除・変更できません**。
> 解除するには、Blueprint の割り当て自体を更新・削除する必要があります。
> 「管理者であっても勝手に設定変更させたくない」という強力なガバナンスが必要な場合に使われます。

---

## 第3章：管理と監視 (Management & Operations)

最後のセクションは、日々の運用業務（コスト管理、自動化、パッチ適用）です。地味ですが、試験では着実に得点源にしたい分野です。

### 3-1. Cost Management (コスト管理)

クラウド破産を防ぐための必須ツールです。

#### 3-1-1. 予算 (Budgets) と アラート
Azure では「予算」を設定し、閾値（例えば予算の80%）に達したらアラートを飛ばすことができます。
*   **アクショングループ (Action Groups)**: アラート発生時に「何をするか」の定義。メール送信、SMS送信、Webhook（Teams通知など）、Azure Functionの実行などが選べます。
*   **注意**: 予算を超過しても、**リソースは自動停止しません**。（VMは止まりません）。アラートが飛ぶだけです。自動停止させたい場合は、アクショングループでAutomation Runbookを呼び出すなどの作り込みが必要です。

#### 3-1-2. コスト分析 (Cost Analysis)
「今月何にいくら使っているか？」をグラフで可視化するツールです。
*   **タグ (Tags)**: コストを部署やプロジェクトごとに按分したい場合、リソースにタグ（CostCenter: 1001 など）を付けるのが基本です。

---

### 3-2. Azure Automation

定型作業を自動化するサービスです。

#### 3-2-1. Runbook
自動化スクリプトそのものです。PowerShell または Python で記述します。
*   **共有モジュール**: 複数のRunbookで使う機能はモジュール化して管理できます。
*   **資格情報 (Credentials)**: パスワードやキーを安全に保存する機能（Asset）があります。スクリプトに平文で書いてはいけません。

#### 3-2-2. Hybrid Runbook Worker (試験頻出)
AzureにあるAutomationアカウントから、**オンプレミスのサーバー** や **VNet内のプライベートなVM** に対してスクリプトを実行したい場合に使います。
*   ターゲットのマシンにエージェントを入れ、Hybrid Workerとして登録します。
*   これにより、クラウド側（Automation）からオンプレミス側のローカルリソースを操作できます。

---

### 3-3. Update Management (更新管理)

Windows / Linux サーバーのパッチ適用を管理する機能です。Azure Automation の機能の一部として提供されます。

#### 3-3-1. 必須構成要素
これを使うには、以下の2つをリンクさせる必要があります。これが試験でよく問われます。
1.  **Azure Automation アカウント**
2.  **Log Analytics ワークスペース**
※ この2つは特定のリージョンの組み合わせ（マッピング）でリンクさせる必要があります。

#### 3-3-2. スケジュールと動的グループ
*   **デプロイスケジュール**: 「毎週日曜日のAM2:00にパッチ適用」といったスケジュールを作成します。
*   **動的グループ (Dynamic Groups)**:
    *   「パッチを当てる対象サーバー」を1台ずつ指定するのはナンセンスです。
    *   **クエリ（タグなど）** に基づいて対象を動的に決定します。
    *   例：「OS: Windows」かつ「Environment: Production」というタグが付いたVMすべて、という指定が可能です。これならVMが増えても設定変更不要です。

---

## 最終章：試験直前チェック！間違いやすいポイントまとめ

最後に、試験直前に見返してほしい「間違いやすいポイント」をまとめました。

1.  **Azure Backup の MARS エージェント** は **SQL Server** のバックアップが取れない（ファイルのみ）。SQLなら **MABS**。
2.  **高可用性** なら **Availability Zones**（データセンターレベルの冗長化）。**災害対策** なら **Region Pairs**（リージョンレベルの冗長化）。
3.  **Site Recovery (ASR)** のテストには **Test Failover** を使う（本番影響なし）。
4.  **リソースロックのReadOnly** は、**アクセスキーの表示(ListKeys)** もブロックする。
5.  **Azure Policy** は **作成をブロック** できるが、**RBAC** は **操作権限** を管理する。
6.  **Update Management** には **Log Analytics** とのリンクが必須。

---

**Good Luck on your Exam!**
このガイドがあなたの合格の一助になれば幸いです。基礎を理解し、シナリオ問題を落ち着いて解けば、必ず合格できます。頑張ってください！


